
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://informatics-isi-edu.github.io/deriva-ml/code-docs/dataset_bag/">
      
      
        <link rel="prev" href="../dataset/">
      
      
        <link rel="next" href="../dataset_split/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>DatasetBag - DerivaML</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#datasetbag-class" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DerivaML" class="md-header__button md-logo" aria-label="DerivaML" data-md-component="logo">
      
  <img src="../../assets/deriva-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DerivaML
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DatasetBag
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DerivaML" class="md-nav__button md-logo" aria-label="DerivaML" data-md-component="logo">
      
  <img src="../../assets/deriva-logo.png" alt="logo">

    </a>
    DerivaML
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview of DerivaML
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/deriva_ml_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DerivaML Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installing deriva-ml
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/identifiers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Identifying things in deriva-ml
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/datasets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Datasets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/file-assets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    File Assets
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/annotations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Catalog Annotations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/execution-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuring an Execution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/hydra-zen-configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hydra-zen Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/running-models-and-notebooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running Models and Notebooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/notebooks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Using DerivaML with Jupyter Notebooks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/cli-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Sample Notebooks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Sample Notebooks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Notebooks/DerivaML%20Dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DerivaML Dataset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Notebooks/DerivaML%20Execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DerivaML Execution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Notebooks/DerivaML%20Features/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DerivaML Features
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Notebooks/DerivaML%20Vocabulary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DerivaML Vocabulary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Library Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Library Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Classes
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Classes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deriva_ml_base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DerivaML
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deriva_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DerivaModel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Datasets
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Datasets
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dataset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    DatasetBag
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    DatasetBag
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag" class="md-nav__link">
    <span class="md-ellipsis">
      
        dataset_bag
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag--download-a-dataset-from-a-catalog" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download a dataset from a catalog
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag--list-dataset-members-by-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        List dataset members by type
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag" class="md-nav__link">
    <span class="md-ellipsis">
      
        DatasetBag
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatasetBag">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag--download-a-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download a dataset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag--list-members-by-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        List members by type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag--navigate-to-nested-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Navigate to nested datasets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.current_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        current_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.dataset_history" class="md-nav__link">
    <span class="md-ellipsis">
      
        dataset_history
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.denormalize_as_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        denormalize_as_dataframe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.denormalize_as_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        denormalize_as_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.find_features" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.get_table_as_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_table_as_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_children" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_children
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_element_types" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_element_types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_members" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_members
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_parents" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_parents
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_executions" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_executions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_feature_values
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="list_feature_values">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values--get-typed-feature-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get typed feature records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values--convert-records-to-dictionaries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convert records to dictionaries
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_tables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.restructure_assets" class="md-nav__link">
    <span class="md-ellipsis">
      
        restructure_assets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.FeatureValueRecord" class="md-nav__link">
    <span class="md-ellipsis">
      
        FeatureValueRecord
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataset_split/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dataset Splitting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataset_aux_classes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dataset Auxiliary Classes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Execution
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Execution
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../execution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Execution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../execution_configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ExecutionConfiguration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Features
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Features
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../feature/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Feature
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Utilities
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Utilities
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deriva_definitions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Definitions & Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../exceptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Exceptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../upload/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Upload
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Release Notes
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag" class="md-nav__link">
    <span class="md-ellipsis">
      
        dataset_bag
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag--download-a-dataset-from-a-catalog" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download a dataset from a catalog
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag--list-dataset-members-by-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        List dataset members by type
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag" class="md-nav__link">
    <span class="md-ellipsis">
      
        DatasetBag
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatasetBag">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag--download-a-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download a dataset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag--list-members-by-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        List members by type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag--navigate-to-nested-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Navigate to nested datasets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.current_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        current_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.dataset_history" class="md-nav__link">
    <span class="md-ellipsis">
      
        dataset_history
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.denormalize_as_dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        denormalize_as_dataframe
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.denormalize_as_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        denormalize_as_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.find_features" class="md-nav__link">
    <span class="md-ellipsis">
      
        find_features
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.get_table_as_dict" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_table_as_dict
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_children" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_children
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_element_types" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_element_types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_members" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_members
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_parents" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_dataset_parents
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_executions" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_executions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_feature_values
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="list_feature_values">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values--get-typed-feature-records" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get typed feature records
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values--convert-records-to-dictionaries" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convert records to dictionaries
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.list_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        list_tables
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.DatasetBag.restructure_assets" class="md-nav__link">
    <span class="md-ellipsis">
      
        restructure_assets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deriva_ml.dataset.dataset_bag.FeatureValueRecord" class="md-nav__link">
    <span class="md-ellipsis">
      
        FeatureValueRecord
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="datasetbag-class">DatasetBag Class</h1>
<p>The DatasetBag class represents a downloaded dataset packaged as a BDBag.
It provides methods to access dataset contents, metadata, and associated files
from the local filesystem.</p>


<div class="doc doc-object doc-module">



<a id="deriva_ml.dataset.dataset_bag"></a>
    <div class="doc doc-contents first">

        <p>SQLite-backed dataset access for downloaded BDBags.</p>
<p>This module provides the DatasetBag class, which allows querying and navigating
downloaded dataset bags using SQLite. When a dataset is downloaded from a Deriva
catalog, it is stored as a BDBag (Big Data Bag) containing:</p>
<ul>
<li>CSV files with table data</li>
<li>Asset files (images, documents, etc.)</li>
<li>A schema.json describing the catalog structure</li>
<li>A fetch.txt manifest of referenced files</li>
</ul>
<p>The DatasetBag class provides a read-only interface to this data, mirroring
the Dataset class API where possible. This allows code to work uniformly
with both live catalog datasets and downloaded bags.</p>
<p>Key concepts:
- DatasetBag wraps a single dataset within a downloaded bag
- A bag may contain multiple datasets (nested/hierarchical)
- All operations are read-only (bags are immutable snapshots)
- Queries use SQLite via SQLAlchemy ORM
- Table-level access (get_table_as_dict, lookup_term) is on the catalog (DerivaMLDatabase)</p>


<details class="typical-usage" open>
  <summary>Typical usage</summary>
  <blockquote>
<blockquote>
<blockquote>
<h2 id="deriva_ml.dataset.dataset_bag--download-a-dataset-from-a-catalog">Download a dataset from a catalog</h2>
<p>bag = ml.download_dataset_bag(dataset_spec)</p>
<h2 id="deriva_ml.dataset.dataset_bag--list-dataset-members-by-type">List dataset members by type</h2>
<p>members = bag.list_dataset_members(recurse=True)
for image in members.get("Image", []):
...     print(image["Filename"])</p>
</blockquote>
</blockquote>
</blockquote>
</details>









<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="deriva_ml.dataset.dataset_bag.DatasetBag" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">DatasetBag</span>


</h2>


    <div class="doc doc-contents ">



        <p>Read-only interface to a downloaded dataset bag.</p>
<p>DatasetBag manages access to a materialized BDBag (Big Data Bag) that contains
a snapshot of dataset data from a Deriva catalog. It provides methods for:</p>
<ul>
<li>Listing dataset members and their attributes</li>
<li>Navigating dataset relationships (parents, children)</li>
<li>Accessing feature values</li>
<li>Denormalizing data across related tables</li>
</ul>
<p>A bag may contain multiple datasets when nested datasets are involved. Each
DatasetBag instance represents a single dataset within the bag - use
list_dataset_children() to navigate to nested datasets.</p>
<p>For catalog-level operations like querying arbitrary tables or looking up
vocabulary terms, use the DerivaMLDatabase class instead.</p>
<p>The class implements the DatasetLike protocol, providing the same read interface
as the Dataset class. This allows code to work with both live catalogs and
downloaded bags interchangeably.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.DatasetBag.dataset_rid">dataset_rid</span></code></td>
            <td>
                  <code><span title="deriva_ml.core.definitions.RID">RID</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The unique Resource Identifier for this dataset.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.DatasetBag.dataset_types">dataset_types</span></code></td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of vocabulary terms describing the dataset type.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.DatasetBag.description">description</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable description of the dataset.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.DatasetBag.execution_rid">execution_rid</span></code></td>
            <td>
                  <code><span title="deriva_ml.core.definitions.RID">RID</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RID of the execution associated with this dataset version, if any.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.DatasetBag.model">model</span></code></td>
            <td>
                  <code><span title="DatabaseModel">DatabaseModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DatabaseModel providing SQLite access to bag data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.DatasetBag.engine">engine</span></code></td>
            <td>
                  <code><span title="sqlalchemy.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQLAlchemy engine for database queries.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.DatasetBag.metadata">metadata</span></code></td>
            <td>
                  <code><span title="MetaData">MetaData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQLAlchemy metadata with table definitions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag--download-a-dataset">Download a dataset</h3>
<p>bag = dataset.download_dataset_bag(version="1.0.0")</p>
<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag--list-members-by-type">List members by type</h3>
<p>members = bag.list_dataset_members()
for image in members.get("Image", []):
...     print(f"File: {image['Filename']}")</p>
<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag--navigate-to-nested-datasets">Navigate to nested datasets</h3>
<p>for child in bag.list_dataset_children():
...     print(f"Nested: {child.dataset_rid}")</p>
</blockquote>
</blockquote>
</blockquote>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DatasetBag</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read-only interface to a downloaded dataset bag.</span>

<span class="sd">    DatasetBag manages access to a materialized BDBag (Big Data Bag) that contains</span>
<span class="sd">    a snapshot of dataset data from a Deriva catalog. It provides methods for:</span>

<span class="sd">    - Listing dataset members and their attributes</span>
<span class="sd">    - Navigating dataset relationships (parents, children)</span>
<span class="sd">    - Accessing feature values</span>
<span class="sd">    - Denormalizing data across related tables</span>

<span class="sd">    A bag may contain multiple datasets when nested datasets are involved. Each</span>
<span class="sd">    DatasetBag instance represents a single dataset within the bag - use</span>
<span class="sd">    list_dataset_children() to navigate to nested datasets.</span>

<span class="sd">    For catalog-level operations like querying arbitrary tables or looking up</span>
<span class="sd">    vocabulary terms, use the DerivaMLDatabase class instead.</span>

<span class="sd">    The class implements the DatasetLike protocol, providing the same read interface</span>
<span class="sd">    as the Dataset class. This allows code to work with both live catalogs and</span>
<span class="sd">    downloaded bags interchangeably.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        dataset_rid (RID): The unique Resource Identifier for this dataset.</span>
<span class="sd">        dataset_types (list[str]): List of vocabulary terms describing the dataset type.</span>
<span class="sd">        description (str): Human-readable description of the dataset.</span>
<span class="sd">        execution_rid (RID | None): RID of the execution associated with this dataset version, if any.</span>
<span class="sd">        model (DatabaseModel): The DatabaseModel providing SQLite access to bag data.</span>
<span class="sd">        engine (Engine): SQLAlchemy engine for database queries.</span>
<span class="sd">        metadata (MetaData): SQLAlchemy metadata with table definitions.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Download a dataset</span>
<span class="sd">        &gt;&gt;&gt; bag = dataset.download_dataset_bag(version=&quot;1.0.0&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # List members by type</span>
<span class="sd">        &gt;&gt;&gt; members = bag.list_dataset_members()</span>
<span class="sd">        &gt;&gt;&gt; for image in members.get(&quot;Image&quot;, []):</span>
<span class="sd">        ...     print(f&quot;File: {image[&#39;Filename&#39;]}&quot;)</span>
<span class="sd">        &gt;&gt;&gt; # Navigate to nested datasets</span>
<span class="sd">        &gt;&gt;&gt; for child in bag.list_dataset_children():</span>
<span class="sd">        ...     print(f&quot;Nested: {child.dataset_rid}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">catalog</span><span class="p">:</span> <span class="s2">&quot;DerivaMLDatabase&quot;</span><span class="p">,</span>
        <span class="n">dataset_rid</span><span class="p">:</span> <span class="n">RID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">dataset_types</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">execution_rid</span><span class="p">:</span> <span class="n">RID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a DatasetBag instance for a dataset within a downloaded bag.</span>

<span class="sd">        This mirrors the Dataset class initialization pattern, where both classes</span>
<span class="sd">        take a catalog-like object as their first argument for consistency.</span>

<span class="sd">        Args:</span>
<span class="sd">            catalog: The DerivaMLDatabase instance providing access to the bag&#39;s data.</span>
<span class="sd">                This implements the DerivaMLCatalog protocol.</span>
<span class="sd">            dataset_rid: The RID of the dataset to wrap. If None, uses the primary</span>
<span class="sd">                dataset RID from the bag.</span>
<span class="sd">            dataset_types: One or more dataset type terms. Can be a single string</span>
<span class="sd">                or list of strings.</span>
<span class="sd">            description: Human-readable description of the dataset.</span>
<span class="sd">            execution_rid: RID of the execution associated with this dataset version.</span>
<span class="sd">                If None, will be looked up from the Dataset_Version table.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DerivaMLException: If no dataset_rid is provided and none can be</span>
<span class="sd">                determined from the bag, or if the RID doesn&#39;t exist in the bag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store reference to the catalog and extract the underlying model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span> <span class="o">=</span> <span class="n">catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">metadata</span>

        <span class="c1"># Use provided RID or fall back to the bag&#39;s primary dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="o">=</span> <span class="n">dataset_rid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dataset_rid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_rid</span> <span class="o">=</span> <span class="n">execution_rid</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_dataset_execution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Execution&quot;</span><span class="p">)</span>

        <span class="c1"># Normalize dataset_types to always be a list of strings for consistency</span>
        <span class="c1"># with the Dataset class interface</span>
        <span class="k">if</span> <span class="n">dataset_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_types</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_types</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_types</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DerivaMLException</span><span class="p">(</span><span class="s2">&quot;No dataset RID provided&quot;</span><span class="p">)</span>

        <span class="c1"># Validate that this dataset exists in the bag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rid_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

        <span class="c1"># Cache the version and dataset table reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dataset_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dataset_table</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the DatasetBag for debugging.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;deriva_ml.DatasetBag object at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="si">}</span><span class="s2">: rid=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;version=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_version</span><span class="si">}</span><span class="s2">&#39;, types=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetVersion</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the version of the dataset at the time the bag was downloaded.</span>

<span class="sd">        For a DatasetBag, this is the version that was current when the bag was</span>
<span class="sd">        created. Unlike the live Dataset class, this value is immutable since</span>
<span class="sd">        bags are read-only snapshots.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DatasetVersion: The semantic version (major.minor.patch) of this dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_version</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all tables available in the bag&#39;s SQLite database.</span>

<span class="sd">        Returns the fully-qualified names of all tables (e.g., &quot;domain.Image&quot;,</span>
<span class="sd">        &quot;deriva-ml.Dataset&quot;) that were exported in this bag.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: Table names in &quot;schema.table&quot; format, sorted alphabetically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_tables</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_table_as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get table contents as dictionaries.</span>

<span class="sd">        Convenience method that delegates to the underlying catalog. This provides</span>
<span class="sd">        access to all rows in a table, not just those belonging to this dataset.</span>
<span class="sd">        For dataset-filtered results, use list_dataset_members() instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: Name of the table to retrieve (e.g., &quot;Subject&quot;, &quot;Image&quot;).</span>

<span class="sd">        Yields:</span>
<span class="sd">            dict: Dictionary for each row in the table.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; for subject in bag.get_table_as_dict(&quot;Subject&quot;):</span>
<span class="sd">            ...     print(subject[&quot;Name&quot;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">get_table_as_dict</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_relationship_attr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the SQLAlchemy relationship attribute connecting two ORM classes.</span>

<span class="sd">        Searches for a relationship on `source` that points to `target`, which is</span>
<span class="sd">        needed to construct proper JOIN clauses in SQL queries.</span>

<span class="sd">        Args:</span>
<span class="sd">            source: Source ORM class or AliasedClass.</span>
<span class="sd">            target: Target ORM class or AliasedClass.</span>

<span class="sd">        Returns:</span>
<span class="sd">            InstrumentedAttribute: The relationship attribute on source pointing to target.</span>

<span class="sd">        Raises:</span>
<span class="sd">            LookupError: If no relationship exists between the two classes.</span>

<span class="sd">        Note:</span>
<span class="sd">            When multiple relationships exist, prefers MANYTOONE direction as this</span>
<span class="sd">            is typically the more natural join direction for denormalization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">src_mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">mapper</span>
        <span class="n">tgt_mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">mapper</span>

        <span class="c1"># Collect all relationships on the source mapper that point to target</span>
        <span class="n">candidates</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">RelationshipProperty</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rel</span> <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">src_mapper</span><span class="o">.</span><span class="n">relationships</span> <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">is</span> <span class="n">tgt_mapper</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No relationship from </span><span class="si">{</span><span class="n">src_mapper</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">tgt_mapper</span><span class="o">.</span><span class="n">class_</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Prefer MANYTOONE when multiple paths exist (often best for joins)</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;MANYTOONE&quot;</span><span class="p">)</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Return the bound attribute (handles AliasedClass properly)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">rel</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">AliasedClass</span><span class="p">)</span> <span class="k">else</span> <span class="n">rel</span><span class="o">.</span><span class="n">class_attribute</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dataset_table_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompoundSelect</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a SQL query for all rows in a table that belong to this dataset.</span>

<span class="sd">        Creates a UNION of queries that traverse all possible paths from the</span>
<span class="sd">        Dataset table to the target table, filtering by this dataset&#39;s RID</span>
<span class="sd">        (and any nested dataset RIDs).</span>

<span class="sd">        This is necessary because table data may be linked to datasets through</span>
<span class="sd">        different relationship paths (e.g., Image might be linked directly to</span>
<span class="sd">        Dataset or through an intermediate Subject table).</span>

<span class="sd">        Args:</span>
<span class="sd">            table: Name of the table to query.</span>

<span class="sd">        Returns:</span>
<span class="sd">            CompoundSelect: A SQLAlchemy UNION query selecting all matching rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">dataset_table_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Include this dataset and all nested datasets in the query</span>
        <span class="n">dataset_rids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dataset_children</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

        <span class="c1"># Find all paths from Dataset to the target table</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[[</span><span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_schema_to_paths</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">table</span><span class="p">]</span>

        <span class="c1"># Build a SELECT query for each path and UNION them together</span>
        <span class="n">sql_cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">path_sql</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">table_class</span><span class="p">)</span>
            <span class="n">last_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># Join through each table in the path</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">t_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">path_sql</span> <span class="o">=</span> <span class="n">path_sql</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_relationship_attr</span><span class="p">(</span><span class="n">last_class</span><span class="p">,</span> <span class="n">t_class</span><span class="p">))</span>
                <span class="n">last_class</span> <span class="o">=</span> <span class="n">t_class</span>
            <span class="c1"># Filter to only rows belonging to our dataset(s)</span>
            <span class="n">path_sql</span> <span class="o">=</span> <span class="n">path_sql</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dataset_table_class</span><span class="o">.</span><span class="n">RID</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">dataset_rids</span><span class="p">))</span>
            <span class="n">sql_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">sql_cmds</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dataset_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DatasetHistory</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the version history of a dataset.</span>

<span class="sd">        Returns a chronological list of dataset versions, including their version numbers,</span>
<span class="sd">        creation times, and associated metadata.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[DatasetHistory]: List of history entries, each containing:</span>
<span class="sd">                - dataset_version: Version number (major.minor.patch)</span>
<span class="sd">                - minid: Minimal Viable Identifier</span>
<span class="sd">                - snapshot: Catalog snapshot time</span>
<span class="sd">                - dataset_rid: Dataset Resource Identifier</span>
<span class="sd">                - version_rid: Version Resource Identifier</span>
<span class="sd">                - description: Version description</span>
<span class="sd">                - execution_rid: Associated execution RID</span>

<span class="sd">        Raises:</span>
<span class="sd">            DerivaMLException: If dataset_rid is not a valid dataset RID.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; history = ml.dataset_history(&quot;1-abc123&quot;)</span>
<span class="sd">            &gt;&gt;&gt; for entry in history:</span>
<span class="sd">            ...     print(f&quot;Version {entry.dataset_version}: {entry.description}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Query Dataset_Version table directly via the model</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">DatasetHistory</span><span class="p">(</span>
                <span class="n">dataset_version</span><span class="o">=</span><span class="n">DatasetVersion</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]),</span>
                <span class="n">minid</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Minid&quot;</span><span class="p">],</span>
                <span class="n">snapshot</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Snapshot&quot;</span><span class="p">],</span>
                <span class="n">dataset_rid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">,</span>
                <span class="n">version_rid</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">],</span>
                <span class="n">description</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">],</span>
                <span class="n">execution_rid</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Execution&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_table_contents</span><span class="p">(</span><span class="s2">&quot;Dataset_Version&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_members</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of entities associated with a specific dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse: Whether to include members of nested datasets.</span>
<span class="sd">            limit: Maximum number of members to return per type. None for no limit.</span>
<span class="sd">            _visited: Internal parameter to track visited datasets and prevent infinite recursion.</span>
<span class="sd">            version: Ignored (bags are immutable snapshots).</span>
<span class="sd">            **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping member types to lists of member records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize visited set for recursion guard</span>
        <span class="k">if</span> <span class="n">_visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Prevent infinite recursion by checking if we&#39;ve already visited this dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">_visited</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">_visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

        <span class="c1"># Look at each of the element types that might be in the _dataset_table and get the list of rid for them from</span>
        <span class="c1"># the appropriate association table.</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="n">dataset_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_for_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_dataset_element_types</span><span class="p">():</span>
            <span class="n">element_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_for_table</span><span class="p">(</span><span class="n">element_table</span><span class="p">)</span>

            <span class="n">assoc_class</span><span class="p">,</span> <span class="n">dataset_rel</span><span class="p">,</span> <span class="n">element_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_association_class</span><span class="p">(</span><span class="n">dataset_class</span><span class="p">,</span> <span class="n">element_class</span><span class="p">)</span>

            <span class="n">element_table</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">element_class</span><span class="p">)</span><span class="o">.</span><span class="n">mapped_table</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">is_domain_schema</span><span class="p">(</span><span class="n">element_table</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span> <span class="ow">and</span> <span class="n">element_table</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">]:</span>
                <span class="c1"># Look at domain tables and nested datasets.</span>
                <span class="k">continue</span>

            <span class="c1"># Get the names of the columns that we are going to need for linking</span>
            <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="c1"># For Dataset_Dataset, use Nested_Dataset column to find nested datasets</span>
                <span class="c1"># (similar to how the live catalog does it in Dataset.list_dataset_members)</span>
                <span class="k">if</span> <span class="n">element_table</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
                    <span class="n">sql_cmd</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">select</span><span class="p">(</span><span class="n">element_class</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assoc_class</span><span class="p">,</span> <span class="n">element_class</span><span class="o">.</span><span class="n">RID</span> <span class="o">==</span> <span class="n">assoc_class</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;Nested_Dataset&quot;</span><span class="p">])</span>
                        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="o">==</span> <span class="n">assoc_class</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For other tables, use the original join via element_rel</span>
                    <span class="n">sql_cmd</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">select</span><span class="p">(</span><span class="n">element_class</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">element_rel</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="o">==</span> <span class="n">assoc_class</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">sql_cmd</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
                <span class="c1"># Get back the list of ORM entities and convert them to dictionaries.</span>
                <span class="n">element_entities</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="n">element_rows</span> <span class="o">=</span> <span class="p">[{</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">element_entities</span><span class="p">]</span>
            <span class="n">members</span><span class="p">[</span><span class="n">element_table</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">element_rows</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">recurse</span> <span class="ow">and</span> <span class="p">(</span><span class="n">element_table</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="c1"># Get the members for all the nested datasets and add to the member list.</span>
                <span class="n">nested_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">element_rows</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">nested_datasets</span><span class="p">:</span>
                    <span class="n">nested_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">lookup_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nested_dataset</span><span class="o">.</span><span class="n">list_dataset_members</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">_visited</span><span class="o">=</span><span class="n">_visited</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">members</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">members</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Feature</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find features for a table.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: The table to find features for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An iterable of Feature instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_features</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_feature_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">FeatureRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves all values for a feature as typed FeatureRecord instances.</span>

<span class="sd">        Returns an iterator of dynamically-generated FeatureRecord objects for each</span>
<span class="sd">        feature value. Each record is an instance of a Pydantic model specific to</span>
<span class="sd">        this feature, with typed attributes for all columns including the Execution</span>
<span class="sd">        that created the feature value.</span>

<span class="sd">        Args:</span>
<span class="sd">            table: The table containing the feature, either as name or Table object.</span>
<span class="sd">            feature_name: Name of the feature to retrieve values for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Iterable[FeatureRecord]: An iterator of FeatureRecord instances.</span>
<span class="sd">                Each instance has:</span>
<span class="sd">                - Execution: RID of the execution that created this feature value</span>
<span class="sd">                - Feature_Name: Name of the feature</span>
<span class="sd">                - All feature-specific columns as typed attributes</span>
<span class="sd">                - model_dump() method to convert back to a dictionary</span>

<span class="sd">        Raises:</span>
<span class="sd">            DerivaMLException: If the feature doesn&#39;t exist or cannot be accessed.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; # Get typed feature records</span>
<span class="sd">            &gt;&gt;&gt; for record in bag.list_feature_values(&quot;Image&quot;, &quot;Quality&quot;):</span>
<span class="sd">            ...     print(f&quot;Image {record.Image}: {record.ImageQuality}&quot;)</span>
<span class="sd">            ...     print(f&quot;Created by execution: {record.Execution}&quot;)</span>

<span class="sd">            &gt;&gt;&gt; # Convert records to dictionaries</span>
<span class="sd">            &gt;&gt;&gt; records = list(bag.list_feature_values(&quot;Image&quot;, &quot;Quality&quot;))</span>
<span class="sd">            &gt;&gt;&gt; dicts = [r.model_dump() for r in records]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get table and feature</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lookup_feature</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">)</span>

        <span class="c1"># Get the dynamically-generated FeatureRecord subclass for this feature</span>
        <span class="n">record_class</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_record_class</span><span class="p">()</span>

        <span class="c1"># Query raw values from SQLite</span>
        <span class="n">feature_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_table</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">feature_table</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

        <span class="c1"># Convert to typed records</span>
        <span class="k">for</span> <span class="n">raw_value</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="c1"># Filter to only include fields that the record class expects</span>
            <span class="n">field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">record_class</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_value</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
            <span class="k">yield</span> <span class="n">record_class</span><span class="p">(</span><span class="o">**</span><span class="n">filtered_data</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_element_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Table</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List the types of elements that can be contained in datasets.</span>

<span class="sd">        This method analyzes the dataset and identifies the data types for all</span>
<span class="sd">        elements within it. It is useful for understanding the structure and</span>
<span class="sd">        content of the dataset and allows for better manipulation and usage of its</span>
<span class="sd">        data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: A list of strings where each string represents a data type</span>
<span class="sd">            of an element found in the dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_dataset_element_types</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_children</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get nested datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse: Whether to include children of children.</span>
<span class="sd">            _visited: Internal parameter to track visited datasets and prevent infinite recursion.</span>
<span class="sd">            version: Ignored (bags are immutable snapshots).</span>
<span class="sd">            **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of child dataset bags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize visited set for recursion guard</span>
        <span class="k">if</span> <span class="n">_visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Prevent infinite recursion by checking if we&#39;ve already visited this dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">_visited</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">_visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

        <span class="n">ds_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset&quot;</span><span class="p">)</span>
        <span class="n">nds_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Dataset&quot;</span><span class="p">)</span>
        <span class="n">dv_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Version&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">sql_cmd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Nested_Dataset</span><span class="p">,</span> <span class="n">dv_table</span><span class="o">.</span><span class="n">Version</span><span class="p">)</span>
                <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">ds_table</span><span class="p">,</span> <span class="n">nds_table</span><span class="p">,</span> <span class="n">onclause</span><span class="o">=</span><span class="n">ds_table</span><span class="o">.</span><span class="n">RID</span> <span class="o">==</span> <span class="n">nds_table</span><span class="o">.</span><span class="n">Nested_Dataset</span><span class="p">)</span>
                <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">ds_table</span><span class="p">,</span> <span class="n">dv_table</span><span class="p">,</span> <span class="n">onclause</span><span class="o">=</span><span class="n">ds_table</span><span class="o">.</span><span class="n">Version</span> <span class="o">==</span> <span class="n">dv_table</span><span class="o">.</span><span class="n">RID</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">nested</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">lookup_dataset</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">nested</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">nested</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">list_dataset_children</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">_visited</span><span class="o">=</span><span class="n">_visited</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_parents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a dataset_table RID, return a list of RIDs of the parent datasets if this is included in a</span>
<span class="sd">        nested dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            recurse: If True, recursively return all ancestor datasets.</span>
<span class="sd">            _visited: Internal parameter to track visited datasets and prevent infinite recursion.</span>
<span class="sd">            version: Ignored (bags are immutable snapshots).</span>
<span class="sd">            **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of parent dataset bags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize visited set for recursion guard</span>
        <span class="k">if</span> <span class="n">_visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Prevent infinite recursion by checking if we&#39;ve already visited this dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">_visited</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">_visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

        <span class="n">nds_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Dataset&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Nested_Dataset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">lookup_dataset</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
                <span class="n">parents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">list_dataset_parents</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_visited</span><span class="o">=</span><span class="n">_visited</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">parents</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">list_executions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">RID</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all execution RIDs associated with this dataset.</span>

<span class="sd">        Returns all executions that used this dataset as input. This is</span>
<span class="sd">        tracked through the Dataset_Execution association table.</span>

<span class="sd">        Note:</span>
<span class="sd">            Unlike the live Dataset class which returns Execution objects,</span>
<span class="sd">            DatasetBag returns a list of execution RIDs since the bag is</span>
<span class="sd">            an offline snapshot and cannot look up live execution objects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of execution RIDs associated with this dataset.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; bag = ml.download_dataset_bag(dataset_spec)</span>
<span class="sd">            &gt;&gt;&gt; execution_rids = bag.list_executions()</span>
<span class="sd">            &gt;&gt;&gt; for rid in execution_rids:</span>
<span class="sd">            ...     print(f&quot;Associated execution: {rid}&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">de_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Execution&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">de_table</span><span class="o">.</span><span class="n">Execution</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">de_table</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_denormalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Select</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a SQL query that joins multiple tables into a denormalized view.</span>

<span class="sd">        This method creates a &quot;wide table&quot; by joining related tables together,</span>
<span class="sd">        producing a single query that returns columns from all specified tables.</span>
<span class="sd">        This is useful for machine learning pipelines that need flat data.</span>

<span class="sd">        The method:</span>
<span class="sd">        1. Analyzes the schema to find join paths between tables</span>
<span class="sd">        2. Determines the correct join order based on foreign key relationships</span>
<span class="sd">        3. Builds SELECT statements with properly aliased columns</span>
<span class="sd">        4. Creates a UNION if multiple paths exist to the same tables</span>

<span class="sd">        Args:</span>
<span class="sd">            include_tables: List of table names to include in the output. Additional</span>
<span class="sd">                tables may be included if they&#39;re needed to join the requested tables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Select: A SQLAlchemy query that produces the denormalized result.</span>

<span class="sd">        Note:</span>
<span class="sd">            Column names in the result are prefixed with the table name to avoid</span>
<span class="sd">            collisions (e.g., &quot;Image.Filename&quot;, &quot;Subject.RID&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Skip over tables that we don&#39;t want to include in the denormalized dataset.</span>
        <span class="c1"># Also, strip off the Dataset/Dataset_X part of the path so we don&#39;t include dataset columns in the denormalized</span>
        <span class="c1"># table.</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">find_relationship</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">join_condition</span><span class="p">):</span>
            <span class="n">side1</span> <span class="o">=</span> <span class="p">(</span><span class="n">join_condition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">join_condition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">side2</span> <span class="o">=</span> <span class="p">(</span><span class="n">join_condition</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">join_condition</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="n">inspect</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span>
                <span class="n">local_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">local_columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">local_columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">remote_side</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">remote_side</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">relationship</span><span class="o">.</span><span class="n">remote_side</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">local_columns</span> <span class="o">==</span> <span class="n">side1</span> <span class="ow">and</span> <span class="n">remote_side</span> <span class="o">==</span> <span class="n">side2</span> <span class="ow">or</span> <span class="n">local_columns</span> <span class="o">==</span> <span class="n">side2</span> <span class="ow">and</span> <span class="n">remote_side</span> <span class="o">==</span> <span class="n">side1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">relationship</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">join_tables</span><span class="p">,</span> <span class="n">denormalized_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_prepare_wide_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">,</span> <span class="n">include_tables</span><span class="p">)</span>

        <span class="n">denormalized_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
            <span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">denormalized_columns</span>
        <span class="p">]</span>
        <span class="n">sql_statements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">join_conditions</span><span class="p">)</span> <span class="ow">in</span> <span class="n">join_tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sql_statement</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="o">*</span><span class="n">denormalized_columns</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_for_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># Skip over dataset table</span>
                <span class="n">table_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="n">on_clause</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">table_class</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">on_condition</span> <span class="ow">in</span> <span class="n">join_conditions</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">:=</span> <span class="n">find_relationship</span><span class="p">(</span><span class="n">table_class</span><span class="p">,</span> <span class="n">on_condition</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="n">sql_statement</span> <span class="o">=</span> <span class="n">sql_statement</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table_class</span><span class="p">,</span> <span class="n">onclause</span><span class="o">=</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">on_clause</span><span class="p">))</span>
            <span class="n">dataset_rid_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dataset_children</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
            <span class="n">dataset_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">sql_statement</span> <span class="o">=</span> <span class="n">sql_statement</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dataset_class</span><span class="o">.</span><span class="n">RID</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">dataset_rid_list</span><span class="p">))</span>
            <span class="n">sql_statements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_statement</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">sql_statements</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_denormalize_from_members</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Denormalize dataset members by joining related tables.</span>

<span class="sd">        This method creates a &quot;wide table&quot; view by joining related tables together,</span>
<span class="sd">        using list_dataset_members() as the data source. This ensures consistency</span>
<span class="sd">        with the catalog-based denormalize implementation. The result has outer join</span>
<span class="sd">        semantics - tables without FK relationships are included with NULL values.</span>

<span class="sd">        The method:</span>
<span class="sd">        1. Gets the list of dataset members for each included table via list_dataset_members</span>
<span class="sd">        2. For each member in the first table, follows foreign key relationships to</span>
<span class="sd">           get related records from other tables</span>
<span class="sd">        3. Tables without FK connections to the first table are included with NULLs</span>
<span class="sd">        4. Includes nested dataset members recursively</span>

<span class="sd">        Args:</span>
<span class="sd">            include_tables: List of table names to include in the output.</span>

<span class="sd">        Yields:</span>
<span class="sd">            dict[str, Any]: Rows with column names prefixed by table name (e.g., &quot;Image.Filename&quot;).</span>
<span class="sd">                Unrelated tables have NULL values for their columns.</span>

<span class="sd">        Note:</span>
<span class="sd">            Column names in the result are prefixed with the table name to avoid</span>
<span class="sd">            collisions (e.g., &quot;Image.Filename&quot;, &quot;Subject.RID&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Skip system columns in output</span>
        <span class="n">skip_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RCT&quot;</span><span class="p">,</span> <span class="s2">&quot;RMT&quot;</span><span class="p">,</span> <span class="s2">&quot;RCB&quot;</span><span class="p">,</span> <span class="s2">&quot;RMB&quot;</span><span class="p">}</span>

        <span class="c1"># Get all members for the included tables (recursively includes nested datasets)</span>
        <span class="n">members</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dataset_members</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Build a lookup of columns for each table</span>
        <span class="n">table_columns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">include_tables</span><span class="p">:</span>
            <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name_to_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
            <span class="n">table_columns</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_columns</span>
            <span class="p">]</span>

        <span class="c1"># Find the primary table (first non-empty table in include_tables)</span>
        <span class="n">primary_table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">include_tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">members</span> <span class="ow">and</span> <span class="n">members</span><span class="p">[</span><span class="n">table_name</span><span class="p">]:</span>
                <span class="n">primary_table</span> <span class="o">=</span> <span class="n">table_name</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">primary_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># No data at all</span>
            <span class="k">return</span>

        <span class="n">primary_table_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name_to_table</span><span class="p">(</span><span class="n">primary_table</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">[</span><span class="n">primary_table</span><span class="p">]:</span>
            <span class="c1"># Build the row with all columns from all tables</span>
            <span class="n">row</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Add primary table columns</span>
            <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">[</span><span class="n">primary_table</span><span class="p">]:</span>
                <span class="n">prefixed_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">primary_table</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">row</span><span class="p">[</span><span class="n">prefixed_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>

            <span class="c1"># For each other table, try to join or add NULL values</span>
            <span class="k">for</span> <span class="n">other_table_name</span> <span class="ow">in</span> <span class="n">include_tables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">other_table_name</span> <span class="o">==</span> <span class="n">primary_table</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">other_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name_to_table</span><span class="p">(</span><span class="n">other_table_name</span><span class="p">)</span>
                <span class="n">other_cols</span> <span class="o">=</span> <span class="n">table_columns</span><span class="p">[</span><span class="n">other_table_name</span><span class="p">]</span>

                <span class="c1"># Initialize all columns to None (outer join behavior)</span>
                <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
                    <span class="n">prefixed_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">other_table_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">prefixed_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Try to find FK relationship and join</span>
                <span class="k">if</span> <span class="n">other_table_name</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">relationship</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_table_relationship</span><span class="p">(</span>
                            <span class="n">primary_table_obj</span><span class="p">,</span> <span class="n">other_table</span>
                        <span class="p">)</span>
                        <span class="n">fk_col</span><span class="p">,</span> <span class="n">pk_col</span> <span class="o">=</span> <span class="n">relationship</span>

                        <span class="c1"># Look up the related record</span>
                        <span class="n">fk_value</span> <span class="o">=</span> <span class="n">member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fk_col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fk_value</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">other_member</span> <span class="ow">in</span> <span class="n">members</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">other_table_name</span><span class="p">,</span> <span class="p">[]):</span>
                                <span class="k">if</span> <span class="n">other_member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk_col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">fk_value</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
                                        <span class="n">prefixed_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">other_table_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&quot;</span>
                                        <span class="n">row</span><span class="p">[</span><span class="n">prefixed_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_member</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
                                    <span class="k">break</span>
                    <span class="k">except</span> <span class="n">DerivaMLException</span><span class="p">:</span>
                        <span class="c1"># No FK relationship - columns remain NULL (outer join)</span>
                        <span class="k">pass</span>

            <span class="k">yield</span> <span class="n">row</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">denormalize_as_dataframe</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Denormalize the dataset bag into a single wide table (DataFrame).</span>

<span class="sd">        Denormalization transforms normalized relational data into a single &quot;wide table&quot;</span>
<span class="sd">        (also called a &quot;flat table&quot; or &quot;denormalized table&quot;) by joining related tables</span>
<span class="sd">        together. This produces a DataFrame where each row contains all related information</span>
<span class="sd">        from multiple source tables, with columns from each table combined side-by-side.</span>

<span class="sd">        Wide tables are the standard input format for most machine learning frameworks,</span>
<span class="sd">        which expect all features for a single observation to be in one row. This method</span>
<span class="sd">        bridges the gap between normalized database schemas and ML-ready tabular data.</span>

<span class="sd">        **How it works:**</span>

<span class="sd">        Tables are joined based on their foreign key relationships stored in the bag&#39;s</span>
<span class="sd">        schema. For example, if Image has a foreign key to Subject, denormalizing</span>
<span class="sd">        [&quot;Subject&quot;, &quot;Image&quot;] produces rows where each image appears with its subject&#39;s</span>
<span class="sd">        metadata.</span>

<span class="sd">        **Column naming:**</span>

<span class="sd">        Column names are prefixed with the source table name using dots to avoid</span>
<span class="sd">        collisions (e.g., &quot;Image.Filename&quot;, &quot;Subject.RID&quot;). This differs from the</span>
<span class="sd">        live Dataset class which uses underscores.</span>

<span class="sd">        Args:</span>
<span class="sd">            include_tables: List of table names to include in the output. Tables</span>
<span class="sd">                are joined based on their foreign key relationships.</span>
<span class="sd">                Order doesn&#39;t matter - the join order is determined automatically.</span>
<span class="sd">            version: Ignored (bags are immutable snapshots of a specific version).</span>
<span class="sd">            **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: Wide table with columns from all included tables.</span>

<span class="sd">        Example:</span>
<span class="sd">            Create a training dataset from a downloaded bag::</span>

<span class="sd">                &gt;&gt;&gt; # Download and materialize the dataset</span>
<span class="sd">                &gt;&gt;&gt; bag = ml.download_dataset_bag(spec, materialize=True)</span>

<span class="sd">                &gt;&gt;&gt; # Denormalize into a wide table</span>
<span class="sd">                &gt;&gt;&gt; df = bag.denormalize_as_dataframe([&quot;Image&quot;, &quot;Diagnosis&quot;])</span>
<span class="sd">                &gt;&gt;&gt; print(df.columns.tolist())</span>
<span class="sd">                [&#39;Image.RID&#39;, &#39;Image.Filename&#39;, &#39;Image.URL&#39;, &#39;Diagnosis.RID&#39;,</span>
<span class="sd">                 &#39;Diagnosis.Label&#39;, &#39;Diagnosis.Confidence&#39;]</span>

<span class="sd">                &gt;&gt;&gt; # Access local file paths for images</span>
<span class="sd">                &gt;&gt;&gt; for _, row in df.iterrows():</span>
<span class="sd">                ...     local_path = bag.get_asset_path(&quot;Image&quot;, row[&quot;Image.RID&quot;])</span>
<span class="sd">                ...     label = row[&quot;Diagnosis.Label&quot;]</span>
<span class="sd">                ...     # Train on local_path with label</span>

<span class="sd">        See Also:</span>
<span class="sd">            denormalize_as_dict: Generator version for memory-efficient processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_from_members</span><span class="p">(</span><span class="n">include_tables</span><span class="o">=</span><span class="n">include_tables</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">denormalize_as_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Denormalize the dataset bag and yield rows as dictionaries.</span>

<span class="sd">        This is a memory-efficient alternative to denormalize_as_dataframe() that</span>
<span class="sd">        yields one row at a time as a dictionary instead of loading all data into</span>
<span class="sd">        a DataFrame. Use this when processing large datasets that may not fit in</span>
<span class="sd">        memory, or when you want to process rows incrementally.</span>

<span class="sd">        Like denormalize_as_dataframe(), this produces a &quot;wide table&quot; representation</span>
<span class="sd">        where each yielded dictionary contains all columns from the joined tables.</span>
<span class="sd">        See denormalize_as_dataframe() for detailed explanation of how denormalization</span>
<span class="sd">        works.</span>

<span class="sd">        **Column naming:**</span>

<span class="sd">        Column names are prefixed with the source table name using dots to avoid</span>
<span class="sd">        collisions (e.g., &quot;Image.Filename&quot;, &quot;Subject.RID&quot;). This differs from the</span>
<span class="sd">        live Dataset class which uses underscores.</span>

<span class="sd">        Args:</span>
<span class="sd">            include_tables: List of table names to include in the output.</span>
<span class="sd">                Tables are joined based on their foreign key relationships.</span>
<span class="sd">            version: Ignored (bags are immutable snapshots of a specific version).</span>
<span class="sd">            **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">        Yields:</span>
<span class="sd">            dict[str, Any]: Dictionary representing one row of the wide table.</span>
<span class="sd">                Keys are column names in &quot;Table.Column&quot; format.</span>

<span class="sd">        Example:</span>
<span class="sd">            Stream through a large dataset for training::</span>

<span class="sd">                &gt;&gt;&gt; bag = ml.download_dataset_bag(spec, materialize=True)</span>
<span class="sd">                &gt;&gt;&gt; for row in bag.denormalize_as_dict([&quot;Image&quot;, &quot;Diagnosis&quot;]):</span>
<span class="sd">                ...     # Get local file path for this image</span>
<span class="sd">                ...     local_path = bag.get_asset_path(&quot;Image&quot;, row[&quot;Image.RID&quot;])</span>
<span class="sd">                ...     label = row[&quot;Diagnosis.Label&quot;]</span>
<span class="sd">                ...     # Process image and label...</span>

<span class="sd">            Build a PyTorch dataset efficiently::</span>

<span class="sd">                &gt;&gt;&gt; class BagDataset(torch.utils.data.IterableDataset):</span>
<span class="sd">                ...     def __init__(self, bag, tables):</span>
<span class="sd">                ...         self.bag = bag</span>
<span class="sd">                ...         self.tables = tables</span>
<span class="sd">                ...     def __iter__(self):</span>
<span class="sd">                ...         for row in self.bag.denormalize_as_dict(self.tables):</span>
<span class="sd">                ...             img_path = self.bag.get_asset_path(&quot;Image&quot;, row[&quot;Image.RID&quot;])</span>
<span class="sd">                ...             yield load_image(img_path), row[&quot;Diagnosis.Label&quot;]</span>

<span class="sd">        See Also:</span>
<span class="sd">            denormalize_as_dataframe: Returns all data as a pandas DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_from_members</span><span class="p">(</span><span class="n">include_tables</span><span class="o">=</span><span class="n">include_tables</span><span class="p">)</span>


    <span class="c1"># =========================================================================</span>
    <span class="c1"># Asset Restructuring Methods</span>
    <span class="c1"># =========================================================================</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_dataset_type_path_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">type_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a mapping from dataset RID to its type path in the hierarchy.</span>

<span class="sd">        Recursively traverses nested datasets to create a mapping where each</span>
<span class="sd">        dataset RID maps to its hierarchical type path (e.g., [&quot;complete&quot;, &quot;training&quot;]).</span>

<span class="sd">        Args:</span>
<span class="sd">            type_selector: Function to select type when dataset has multiple types.</span>
<span class="sd">                Receives list of type names, returns selected type name.</span>
<span class="sd">                Defaults to selecting first type or &quot;unknown&quot; if no types.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping dataset RID to list of type names from root to leaf.</span>
<span class="sd">            e.g., {&quot;4-ABC&quot;: [&quot;complete&quot;, &quot;training&quot;], &quot;4-DEF&quot;: [&quot;complete&quot;, &quot;testing&quot;]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">type_selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_selector</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">types</span><span class="p">:</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">types</span> <span class="k">else</span> <span class="s2">&quot;Testing&quot;</span>

        <span class="n">type_paths</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">traverse</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">DatasetBag</span><span class="p">,</span> <span class="n">parent_path</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

            <span class="n">current_type</span> <span class="o">=</span> <span class="n">type_selector</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">)</span>
            <span class="n">current_path</span> <span class="o">=</span> <span class="n">parent_path</span> <span class="o">+</span> <span class="p">[</span><span class="n">current_type</span><span class="p">]</span>
            <span class="n">type_paths</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_path</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">list_dataset_children</span><span class="p">():</span>
                <span class="n">traverse</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">current_path</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>

        <span class="n">traverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">type_paths</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_asset_dataset_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="n">RID</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map asset RIDs to their containing dataset RID.</span>

<span class="sd">        For each asset in the specified table, determines which dataset it belongs to.</span>
<span class="sd">        This uses _dataset_table_view to find assets reachable through any FK path</span>
<span class="sd">        from the dataset, not just directly associated assets.</span>

<span class="sd">        Assets are mapped to their most specific (leaf) dataset in the hierarchy.</span>
<span class="sd">        For example, if a Split dataset contains Training and Testing children,</span>
<span class="sd">        and images are members of Training, the images map to Training (not Split).</span>

<span class="sd">        Args:</span>
<span class="sd">            asset_table: Name of the asset table (e.g., &quot;Image&quot;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping asset RID to the dataset RID that contains it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">asset_to_dataset</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="n">RID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">collect_from_dataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="n">DatasetBag</span><span class="p">,</span> <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

            <span class="c1"># Process children FIRST (depth-first) so leaf datasets get priority</span>
            <span class="c1"># This ensures assets are mapped to their most specific dataset</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">list_dataset_children</span><span class="p">():</span>
                <span class="n">collect_from_dataset</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>

            <span class="c1"># Then process this dataset&#39;s assets</span>
            <span class="c1"># Only set if not already mapped (child/leaf dataset wins)</span>
            <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">_get_reachable_assets</span><span class="p">(</span><span class="n">asset_table</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">asset</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">asset_to_dataset</span><span class="p">:</span>
                    <span class="n">asset_to_dataset</span><span class="p">[</span><span class="n">asset</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dataset_rid</span>

        <span class="n">collect_from_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">asset_to_dataset</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_reachable_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all assets reachable from this dataset through any FK path.</span>

<span class="sd">        Unlike list_dataset_members which only returns directly associated entities,</span>
<span class="sd">        this method traverses foreign key relationships to find assets that are</span>
<span class="sd">        indirectly connected to the dataset. For example, if a dataset contains</span>
<span class="sd">        Subjects, and Subject -&gt; Encounter -&gt; Image, this method will find those</span>
<span class="sd">        Images even though they&#39;re not directly in the Dataset_Image association table.</span>

<span class="sd">        Args:</span>
<span class="sd">            asset_table: Name of the asset table (e.g., &quot;Image&quot;)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of asset records as dictionaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use the _dataset_table_view query which traverses all FK paths</span>
        <span class="n">sql_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table_view</span><span class="p">(</span><span class="n">asset_table</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">)</span>
            <span class="c1"># Convert rows to dictionaries</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">rows</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_feature_values_cache</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">asset_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">group_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">enforce_vocabulary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">value_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">FeatureValueRecord</span><span class="p">]],</span> <span class="n">FeatureValueRecord</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load feature values into a cache for efficient lookup.</span>

<span class="sd">        Pre-loads feature values for any group_keys that are feature names,</span>
<span class="sd">        organizing them by target entity RID for fast lookup.</span>

<span class="sd">        Args:</span>
<span class="sd">            asset_table: The asset table name to find features for.</span>
<span class="sd">            group_keys: List of potential feature names to cache. Supports two formats:</span>
<span class="sd">                - &quot;FeatureName&quot;: Uses the first term column (default behavior)</span>
<span class="sd">                - &quot;FeatureName.column_name&quot;: Uses the specified column from the feature table</span>
<span class="sd">            enforce_vocabulary: If True (default), only allow features with</span>
<span class="sd">                controlled vocabulary term columns and raise an error if an</span>
<span class="sd">                asset has multiple values. If False, allow any feature type</span>
<span class="sd">                and use the first value found when multiple exist.</span>
<span class="sd">            value_selector: Optional function to select which feature value to use</span>
<span class="sd">                when an asset has multiple values for the same feature. Receives a</span>
<span class="sd">                list of FeatureValueRecord objects (each with execution_rid for</span>
<span class="sd">                provenance) and returns the selected one. If not provided and</span>
<span class="sd">                multiple values exist, raises DerivaMLException when</span>
<span class="sd">                enforce_vocabulary=True or uses the first value when False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary mapping group_key -&gt; {target_rid -&gt; feature_value}</span>
<span class="sd">            Only includes entries for keys that are actually features.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DerivaMLException: If enforce_vocabulary is True and:</span>
<span class="sd">                - A feature has no term columns (not vocabulary-based), or</span>
<span class="sd">                - An asset has multiple different vocabulary term values for the same feature</span>
<span class="sd">                  and no value_selector is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">deriva_ml.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">DerivaMLException</span>

        <span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Store all feature value records for later selection when there are multiples</span>
        <span class="n">records_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">FeatureValueRecord</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;deriva_ml&quot;</span><span class="p">)</span>

        <span class="c1"># Parse group_keys to extract feature names and optional column specifications</span>
        <span class="c1"># Format: &quot;FeatureName&quot; or &quot;FeatureName.column_name&quot;</span>
        <span class="n">feature_column_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># group_key -&gt; specific column or None</span>
        <span class="n">feature_names_to_check</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">group_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">feature_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">feature_column_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_name</span>
                <span class="n">feature_names_to_check</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feature_column_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">feature_names_to_check</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">process_feature</span><span class="p">(</span><span class="n">feat</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">group_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">specific_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Process a single feature and add its values to the cache.&quot;&quot;&quot;</span>
            <span class="n">term_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feat</span><span class="o">.</span><span class="n">term_columns</span><span class="p">]</span>
            <span class="n">value_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">feat</span><span class="o">.</span><span class="n">value_columns</span><span class="p">]</span>
            <span class="n">all_cols</span> <span class="o">=</span> <span class="n">term_cols</span> <span class="o">+</span> <span class="n">value_cols</span>

            <span class="c1"># Determine which column to use for the value</span>
            <span class="k">if</span> <span class="n">specific_column</span><span class="p">:</span>
                <span class="c1"># User specified a specific column</span>
                <span class="k">if</span> <span class="n">specific_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_cols</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DerivaMLException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">specific_column</span><span class="si">}</span><span class="s2">&#39; not found in feature &#39;</span><span class="si">{</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Available columns: </span><span class="si">{</span><span class="n">all_cols</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">use_column</span> <span class="o">=</span> <span class="n">specific_column</span>
            <span class="k">elif</span> <span class="n">term_cols</span><span class="p">:</span>
                <span class="c1"># Use first term column (default behavior)</span>
                <span class="n">use_column</span> <span class="o">=</span> <span class="n">term_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">enforce_vocabulary</span> <span class="ow">and</span> <span class="n">value_cols</span><span class="p">:</span>
                <span class="c1"># Fall back to value columns if allowed</span>
                <span class="n">use_column</span> <span class="o">=</span> <span class="n">value_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enforce_vocabulary</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DerivaMLException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Feature &#39;</span><span class="si">{</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&#39; on table &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39; has no &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;controlled vocabulary term columns. Only vocabulary-based features &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;can be used for grouping when enforce_vocabulary=True. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Set enforce_vocabulary=False to allow non-vocabulary features.&quot;</span>
                    <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">records_cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="n">feature_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_feature_values</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">feat</span><span class="o">.</span><span class="n">feature_name</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fv</span> <span class="ow">in</span> <span class="n">feature_values</span><span class="p">:</span>
                <span class="c1"># Convert FeatureRecord to dict for easier access</span>
                <span class="n">fv_dict</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
                <span class="n">target_col</span> <span class="o">=</span> <span class="n">table_name</span>
                <span class="k">if</span> <span class="n">target_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fv_dict</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">target_rid</span> <span class="o">=</span> <span class="n">fv_dict</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span>

                <span class="c1"># Get the value from the specified column</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">fv_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">use_column</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_column</span> <span class="ow">in</span> <span class="n">fv_dict</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Create a FeatureValueRecord with execution provenance</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">FeatureValueRecord</span><span class="p">(</span>
                    <span class="n">target_rid</span><span class="o">=</span><span class="n">target_rid</span><span class="p">,</span>
                    <span class="n">feature_name</span><span class="o">=</span><span class="n">feat</span><span class="o">.</span><span class="n">feature_name</span><span class="p">,</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">execution_rid</span><span class="o">=</span><span class="n">fv_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Execution&quot;</span><span class="p">),</span>
                    <span class="n">raw_record</span><span class="o">=</span><span class="n">fv_dict</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">records_cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">][</span><span class="n">target_rid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="c1"># Find all features on tables that this asset table references</span>
        <span class="n">asset_table_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name_to_table</span><span class="p">(</span><span class="n">asset_table</span><span class="p">)</span>

        <span class="c1"># Check features on the asset table itself</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_features</span><span class="p">(</span><span class="n">asset_table</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_name</span> <span class="ow">in</span> <span class="n">feature_names_to_check</span><span class="p">:</span>
                <span class="c1"># Find all group_keys that reference this feature</span>
                <span class="k">for</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">specific_col</span> <span class="ow">in</span> <span class="n">feature_column_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Check if this group_key references this feature</span>
                    <span class="n">key_feature</span> <span class="o">=</span> <span class="n">group_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">group_key</span> <span class="k">else</span> <span class="n">group_key</span>
                    <span class="k">if</span> <span class="n">key_feature</span> <span class="o">==</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_name</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">process_feature</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">asset_table</span><span class="p">,</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">specific_col</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">DerivaMLException</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load feature </span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Also check features on referenced tables (via foreign keys)</span>
        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">asset_table_obj</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">target_table</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">pk_table</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_features</span><span class="p">(</span><span class="n">target_table</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_name</span> <span class="ow">in</span> <span class="n">feature_names_to_check</span><span class="p">:</span>
                    <span class="c1"># Find all group_keys that reference this feature</span>
                    <span class="k">for</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">specific_col</span> <span class="ow">in</span> <span class="n">feature_column_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># Check if this group_key references this feature</span>
                        <span class="n">key_feature</span> <span class="o">=</span> <span class="n">group_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">group_key</span> <span class="k">else</span> <span class="n">group_key</span>
                        <span class="k">if</span> <span class="n">key_feature</span> <span class="o">==</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_name</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">process_feature</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">target_table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">specific_col</span><span class="p">)</span>
                            <span class="k">except</span> <span class="n">DerivaMLException</span><span class="p">:</span>
                                <span class="k">raise</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load feature </span><span class="si">{</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Now resolve multiple values using value_selector or error handling</span>
        <span class="k">for</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">target_records</span> <span class="ow">in</span> <span class="n">records_cache</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">target_rid</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">target_records</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Single value - straightforward</span>
                    <span class="n">cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">][</span><span class="n">target_rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Multiple values - need to resolve</span>
                    <span class="n">unique_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># All records have same value, use it</span>
                        <span class="n">cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">][</span><span class="n">target_rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">elif</span> <span class="n">value_selector</span><span class="p">:</span>
                        <span class="c1"># Use provided selector function</span>
                        <span class="n">selected</span> <span class="o">=</span> <span class="n">value_selector</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
                        <span class="n">cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">][</span><span class="n">target_rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span><span class="o">.</span><span class="n">value</span>
                    <span class="k">elif</span> <span class="n">enforce_vocabulary</span><span class="p">:</span>
                        <span class="c1"># Multiple different values without selector - error</span>
                        <span class="n">values_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; (exec: </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">execution_rid</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">records</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">DerivaMLException</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Asset &#39;</span><span class="si">{</span><span class="n">target_rid</span><span class="si">}</span><span class="s2">&#39; has multiple different values for &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;feature &#39;</span><span class="si">{</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">values_str</span><span class="si">}</span><span class="s2">. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Provide a value_selector function to choose between values, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;or set enforce_vocabulary=False to use the first value.&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Not enforcing - use first value</span>
                        <span class="n">cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">][</span><span class="n">target_rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="k">return</span> <span class="n">cache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_grouping_value</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">asset</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">group_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">feature_cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">RID</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve a grouping value for an asset.</span>

<span class="sd">        First checks if group_key is a direct column on the asset record,</span>
<span class="sd">        then checks if it&#39;s a feature name in the feature cache.</span>

<span class="sd">        Args:</span>
<span class="sd">            asset: The asset record dictionary.</span>
<span class="sd">            group_key: Column name or feature name to group by.</span>
<span class="sd">            feature_cache: Pre-loaded feature values keyed by feature name -&gt; target RID -&gt; value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The resolved value as a string, or &quot;Unknown&quot; if not found or None.</span>
<span class="sd">            Uses &quot;Unknown&quot; (capitalized) to match vocabulary term naming conventions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First check if it&#39;s a direct column on the asset table</span>
        <span class="k">if</span> <span class="n">group_key</span> <span class="ow">in</span> <span class="n">asset</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">asset</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;Unknown&quot;</span>

        <span class="c1"># Check if it&#39;s a feature name</span>
        <span class="k">if</span> <span class="n">group_key</span> <span class="ow">in</span> <span class="n">feature_cache</span><span class="p">:</span>
            <span class="n">feature_values</span> <span class="o">=</span> <span class="n">feature_cache</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span>
            <span class="c1"># Check each column in the asset that might be a FK to the feature target</span>
            <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">column_value</span> <span class="ow">in</span> <span class="n">asset</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">column_value</span> <span class="ow">and</span> <span class="n">column_value</span> <span class="ow">in</span> <span class="n">feature_values</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">feature_values</span><span class="p">[</span><span class="n">column_value</span><span class="p">])</span>
            <span class="c1"># Also check if the asset&#39;s own RID is in the feature values</span>
            <span class="k">if</span> <span class="n">asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RID&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">feature_values</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">feature_values</span><span class="p">[</span><span class="n">asset</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">]])</span>

        <span class="k">return</span> <span class="s2">&quot;Unknown&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_detect_asset_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-detect the asset table from dataset members.</span>

<span class="sd">        Searches for asset tables in the dataset members by examining</span>
<span class="sd">        the schema. Returns the first asset table found, or None if</span>
<span class="sd">        no asset tables are in the dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Name of the detected asset table, or None if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">members</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dataset_members</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table_name</span> <span class="o">==</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Check if this table is an asset table</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name_to_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">is_asset</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">table_name</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_dataset_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate that the dataset or its children have Training/Testing types.</span>

<span class="sd">        Checks if this dataset is of type Training or Testing, or if it has</span>
<span class="sd">        nested children of those types. Returns the valid types found.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Training/Testing type names found, or None if validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_types</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Training&quot;</span><span class="p">,</span> <span class="s2">&quot;Testing&quot;</span><span class="p">}</span>
        <span class="n">found_types</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">check_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">DatasetBag</span><span class="p">,</span> <span class="n">visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ds</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">valid_types</span><span class="p">:</span>
                    <span class="n">found_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">list_dataset_children</span><span class="p">():</span>
                <span class="n">check_dataset</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>

        <span class="n">check_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">found_types</span><span class="p">)</span> <span class="k">if</span> <span class="n">found_types</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">restructure_assets</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">asset_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">group_by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_symlinks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">type_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">type_to_dir_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">enforce_vocabulary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">value_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">FeatureValueRecord</span><span class="p">]],</span> <span class="n">FeatureValueRecord</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restructure downloaded assets into a directory hierarchy.</span>

<span class="sd">        Creates a directory structure organizing assets by dataset types and</span>
<span class="sd">        grouping values. This is useful for ML workflows that expect data</span>
<span class="sd">        organized in conventional folder structures (e.g., PyTorch ImageFolder).</span>

<span class="sd">        The dataset should be of type Training or Testing, or have nested</span>
<span class="sd">        children of those types. The top-level directory name is determined</span>
<span class="sd">        by the dataset type (e.g., &quot;Training&quot; -&gt; &quot;training&quot;).</span>

<span class="sd">        **Finding assets through foreign key relationships:**</span>

<span class="sd">        Assets are found by traversing all foreign key paths from the dataset,</span>
<span class="sd">        not just direct associations. For example, if a dataset contains Subjects,</span>
<span class="sd">        and the schema has Subject -&gt; Encounter -&gt; Image relationships, this method</span>
<span class="sd">        will find all Images reachable through those paths even though they are</span>
<span class="sd">        not directly in a Dataset_Image association table.</span>

<span class="sd">        **Handling datasets without types (prediction scenarios):**</span>

<span class="sd">        If a dataset has no type defined, it is treated as Testing. This is</span>
<span class="sd">        common for prediction/inference scenarios where you want to apply a</span>
<span class="sd">        trained model to new unlabeled data.</span>

<span class="sd">        **Handling missing labels:**</span>

<span class="sd">        If an asset doesn&#39;t have a value for a group_by key (e.g., no label</span>
<span class="sd">        assigned), it is placed in an &quot;Unknown&quot; directory. This allows</span>
<span class="sd">        restructure_assets to work with unlabeled data for prediction.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_dir: Base directory for restructured assets.</span>
<span class="sd">            asset_table: Name of the asset table (e.g., &quot;Image&quot;). If None,</span>
<span class="sd">                auto-detects from dataset members. Raises DerivaMLException</span>
<span class="sd">                if multiple asset tables are found and none is specified.</span>
<span class="sd">            group_by: Names to group assets by. Each name creates a subdirectory</span>
<span class="sd">                level after the dataset type path. Names can be:</span>

<span class="sd">                - **Column names**: Direct columns on the asset table. The column</span>
<span class="sd">                  value becomes the subdirectory name.</span>
<span class="sd">                - **Feature names**: Features defined on the asset table (or tables</span>
<span class="sd">                  it references via foreign keys). The feature&#39;s vocabulary term</span>
<span class="sd">                  value becomes the subdirectory name.</span>
<span class="sd">                - **Feature.column**: Specify a particular column from a multi-term</span>
<span class="sd">                  feature (e.g., &quot;Classification.Label&quot; to use the Label column).</span>

<span class="sd">                Column names are checked first, then feature names. If a value</span>
<span class="sd">                is not found, &quot;unknown&quot; is used as the subdirectory name.</span>

<span class="sd">            use_symlinks: If True (default), create symlinks to original files.</span>
<span class="sd">                If False, copy files. Symlinks save disk space but require</span>
<span class="sd">                the original bag to remain in place.</span>
<span class="sd">            type_selector: Function to select type when dataset has multiple types.</span>
<span class="sd">                Receives list of type names, returns selected type name.</span>
<span class="sd">                Defaults to selecting first type or &quot;unknown&quot; if no types.</span>
<span class="sd">            type_to_dir_map: Optional mapping from dataset type names to directory</span>
<span class="sd">                names. Defaults to {&quot;Training&quot;: &quot;training&quot;, &quot;Testing&quot;: &quot;testing&quot;,</span>
<span class="sd">                &quot;Unknown&quot;: &quot;unknown&quot;}. Use this to customize directory names or</span>
<span class="sd">                add new type mappings.</span>
<span class="sd">            enforce_vocabulary: If True (default), only allow features that have</span>
<span class="sd">                controlled vocabulary term columns, and raise an error if an asset</span>
<span class="sd">                has multiple different values for the same feature without a</span>
<span class="sd">                value_selector. This ensures clean, unambiguous directory structures.</span>
<span class="sd">                If False, allow any feature type and use the first value found</span>
<span class="sd">                when multiple values exist.</span>
<span class="sd">            value_selector: Optional function to select which feature value to use</span>
<span class="sd">                when an asset has multiple values for the same feature. Receives a</span>
<span class="sd">                list of FeatureValueRecord objects (each containing target_rid,</span>
<span class="sd">                feature_name, value, execution_rid, and raw_record) and returns</span>
<span class="sd">                the selected FeatureValueRecord. Use execution_rid to distinguish</span>
<span class="sd">                between values from different executions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Path to the output directory.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DerivaMLException: If asset_table cannot be determined (multiple</span>
<span class="sd">                asset tables exist without specification), if no valid dataset</span>
<span class="sd">                types (Training/Testing) are found, or if enforce_vocabulary</span>
<span class="sd">                is True and a feature has multiple values without value_selector.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Basic restructuring with auto-detected asset table::</span>

<span class="sd">                bag.restructure_assets(</span>
<span class="sd">                    output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                    group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">                )</span>
<span class="sd">                # Creates:</span>
<span class="sd">                # ./ml_data/training/Normal/image1.jpg</span>
<span class="sd">                # ./ml_data/testing/Abnormal/image2.jpg</span>

<span class="sd">            Custom type-to-directory mapping::</span>

<span class="sd">                bag.restructure_assets(</span>
<span class="sd">                    output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                    group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">                    type_to_dir_map={&quot;Training&quot;: &quot;train&quot;, &quot;Testing&quot;: &quot;test&quot;},</span>
<span class="sd">                )</span>
<span class="sd">                # Creates:</span>
<span class="sd">                # ./ml_data/train/Normal/image1.jpg</span>
<span class="sd">                # ./ml_data/test/Abnormal/image2.jpg</span>

<span class="sd">            Select specific feature column for multi-term features::</span>

<span class="sd">                bag.restructure_assets(</span>
<span class="sd">                    output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                    group_by=[&quot;Classification.Label&quot;],  # Use Label column</span>
<span class="sd">                )</span>

<span class="sd">            Handle multiple feature values with a selector::</span>

<span class="sd">                def select_latest(records: list[FeatureValueRecord]) -&gt; FeatureValueRecord:</span>
<span class="sd">                    # Select value from most recent execution</span>
<span class="sd">                    return max(records, key=lambda r: r.execution_rid or &quot;&quot;)</span>

<span class="sd">                bag.restructure_assets(</span>
<span class="sd">                    output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                    group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">                    value_selector=select_latest,</span>
<span class="sd">                )</span>

<span class="sd">            Prediction scenario with unlabeled data::</span>

<span class="sd">                # Dataset has no type - treated as Testing</span>
<span class="sd">                # Assets have no labels - placed in Unknown directory</span>
<span class="sd">                bag.restructure_assets(</span>
<span class="sd">                    output_dir=&quot;./prediction_data&quot;,</span>
<span class="sd">                    group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">                )</span>
<span class="sd">                # Creates:</span>
<span class="sd">                # ./prediction_data/testing/Unknown/image1.jpg</span>
<span class="sd">                # ./prediction_data/testing/Unknown/image2.jpg</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;deriva_ml&quot;</span><span class="p">)</span>
        <span class="n">group_by</span> <span class="o">=</span> <span class="n">group_by</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Default type-to-directory mapping</span>
        <span class="k">if</span> <span class="n">type_to_dir_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">type_to_dir_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Training&quot;</span><span class="p">:</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;Testing&quot;</span><span class="p">:</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>

        <span class="c1"># Auto-detect asset table if not provided</span>
        <span class="k">if</span> <span class="n">asset_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">asset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_asset_table</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">asset_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DerivaMLException</span><span class="p">(</span>
                    <span class="s2">&quot;Could not auto-detect asset table. No asset tables found in dataset members. &quot;</span>
                    <span class="s2">&quot;Specify the asset_table parameter explicitly.&quot;</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected asset table: </span><span class="si">{</span><span class="n">asset_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Step 1: Build dataset type path map with directory name mapping</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">map_type_to_dir</span><span class="p">(</span><span class="n">types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Map dataset types to directory name using type_to_dir_map.</span>

<span class="sd">            If dataset has no types, treat it as Testing (prediction use case).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">types</span><span class="p">:</span>
                <span class="c1"># No types defined - treat as Testing for prediction scenarios</span>
                <span class="k">return</span> <span class="n">type_to_dir_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Testing&quot;</span><span class="p">,</span> <span class="s2">&quot;testing&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_selector</span><span class="p">:</span>
                <span class="n">selected_type</span> <span class="o">=</span> <span class="n">type_selector</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_type</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">type_to_dir_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selected_type</span><span class="p">,</span> <span class="n">selected_type</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">type_path_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_dataset_type_path_map</span><span class="p">(</span><span class="n">map_type_to_dir</span><span class="p">)</span>

        <span class="c1"># Step 2: Get asset-to-dataset mapping</span>
        <span class="n">asset_dataset_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_dataset_mapping</span><span class="p">(</span><span class="n">asset_table</span><span class="p">)</span>

        <span class="c1"># Step 3: Load feature values cache for relevant features</span>
        <span class="n">feature_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_feature_values_cache</span><span class="p">(</span>
            <span class="n">asset_table</span><span class="p">,</span> <span class="n">group_by</span><span class="p">,</span> <span class="n">enforce_vocabulary</span><span class="p">,</span> <span class="n">value_selector</span>
        <span class="p">)</span>

        <span class="c1"># Step 4: Get all assets reachable through FK paths</span>
        <span class="c1"># This uses _get_reachable_assets which traverses FK relationships,</span>
        <span class="c1"># so assets connected via Subject -&gt; Encounter -&gt; Image are found</span>
        <span class="c1"># even if the dataset only contains Subjects directly.</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reachable_assets</span><span class="p">(</span><span class="n">asset_table</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">assets</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No assets found in table &#39;</span><span class="si">{</span><span class="n">asset_table</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output_dir</span>

        <span class="c1"># Step 5: Process each asset</span>
        <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
            <span class="c1"># Get source file path</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Filename&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asset </span><span class="si">{</span><span class="n">asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RID&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> has no Filename&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">source_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">source_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asset file not found: </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Get dataset type path</span>
            <span class="n">dataset_rid</span> <span class="o">=</span> <span class="n">asset_dataset_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">])</span>
            <span class="n">type_path</span> <span class="o">=</span> <span class="n">type_path_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataset_rid</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">])</span>

            <span class="c1"># Resolve grouping values</span>
            <span class="n">group_path</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">group_by</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_grouping_value</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">feature_cache</span><span class="p">)</span>
                <span class="n">group_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># Build target directory</span>
            <span class="n">target_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="o">*</span><span class="n">type_path</span><span class="p">,</span> <span class="o">*</span><span class="n">group_path</span><span class="p">)</span>
            <span class="n">target_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Create link or copy</span>
            <span class="n">target_path</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="n">source_path</span><span class="o">.</span><span class="n">name</span>

            <span class="c1"># Handle existing files</span>
            <span class="k">if</span> <span class="n">target_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">target_path</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
                <span class="n">target_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">use_symlinks</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">target_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">source_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Fall back to copy on platforms that don&#39;t support symlinks</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symlink failed, falling back to copy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">output_dir</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.current_version" class="doc doc-heading">
            <span class="doc doc-object-name doc-attribute-name">current_version</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">current_version</span><span class="p">:</span> <span class="n">DatasetVersion</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get the version of the dataset at the time the bag was downloaded.</p>
<p>For a DatasetBag, this is the version that was current when the bag was
created. Unlike the live Dataset class, this value is immutable since
bags are read-only snapshots.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>DatasetVersion</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="DatasetVersion (deriva_ml.dataset.aux_classes.DatasetVersion)" href="../dataset_aux_classes/#deriva_ml.dataset.aux_classes.DatasetVersion">DatasetVersion</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The semantic version (major.minor.patch) of this dataset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.__init__" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">__init__</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__init__</span><span class="p">(</span>
    <span class="n">catalog</span><span class="p">:</span> <span class="s2">&quot;DerivaMLDatabase&quot;</span><span class="p">,</span>
    <span class="n">dataset_rid</span><span class="p">:</span> <span class="n">RID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dataset_types</span><span class="p">:</span> <span class="nb">str</span>
    <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">execution_rid</span><span class="p">:</span> <span class="n">RID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Initialize a DatasetBag instance for a dataset within a downloaded bag.</p>
<p>This mirrors the Dataset class initialization pattern, where both classes
take a catalog-like object as their first argument for consistency.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>catalog</code>
            </td>
            <td>
                  <code>&#39;DerivaMLDatabase&#39;</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The DerivaMLDatabase instance providing access to the bag's data.
This implements the DerivaMLCatalog protocol.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dataset_rid</code>
            </td>
            <td>
                  <code><span title="deriva_ml.core.definitions.RID">RID</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The RID of the dataset to wrap. If None, uses the primary
dataset RID from the bag.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dataset_types</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>One or more dataset type terms. Can be a single string
or list of strings.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>description</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable description of the dataset.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>execution_rid</code>
            </td>
            <td>
                  <code><span title="deriva_ml.core.definitions.RID">RID</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RID of the execution associated with this dataset version.
If None, will be looked up from the Dataset_Version table.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="DerivaMLException (deriva_ml.core.exceptions.DerivaMLException)" href="../exceptions/#deriva_ml.core.exceptions.DerivaMLException">DerivaMLException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no dataset_rid is provided and none can be
determined from the bag, or if the RID doesn't exist in the bag.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">catalog</span><span class="p">:</span> <span class="s2">&quot;DerivaMLDatabase&quot;</span><span class="p">,</span>
    <span class="n">dataset_rid</span><span class="p">:</span> <span class="n">RID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dataset_types</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">execution_rid</span><span class="p">:</span> <span class="n">RID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize a DatasetBag instance for a dataset within a downloaded bag.</span>

<span class="sd">    This mirrors the Dataset class initialization pattern, where both classes</span>
<span class="sd">    take a catalog-like object as their first argument for consistency.</span>

<span class="sd">    Args:</span>
<span class="sd">        catalog: The DerivaMLDatabase instance providing access to the bag&#39;s data.</span>
<span class="sd">            This implements the DerivaMLCatalog protocol.</span>
<span class="sd">        dataset_rid: The RID of the dataset to wrap. If None, uses the primary</span>
<span class="sd">            dataset RID from the bag.</span>
<span class="sd">        dataset_types: One or more dataset type terms. Can be a single string</span>
<span class="sd">            or list of strings.</span>
<span class="sd">        description: Human-readable description of the dataset.</span>
<span class="sd">        execution_rid: RID of the execution associated with this dataset version.</span>
<span class="sd">            If None, will be looked up from the Dataset_Version table.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DerivaMLException: If no dataset_rid is provided and none can be</span>
<span class="sd">            determined from the bag, or if the RID doesn&#39;t exist in the bag.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Store reference to the catalog and extract the underlying model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span> <span class="o">=</span> <span class="n">catalog</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">metadata</span>

    <span class="c1"># Use provided RID or fall back to the bag&#39;s primary dataset</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="o">=</span> <span class="n">dataset_rid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dataset_rid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">execution_rid</span> <span class="o">=</span> <span class="n">execution_rid</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_dataset_execution</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Execution&quot;</span><span class="p">)</span>

    <span class="c1"># Normalize dataset_types to always be a list of strings for consistency</span>
    <span class="c1"># with the Dataset class interface</span>
    <span class="k">if</span> <span class="n">dataset_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset_types</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dataset_types</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset_types</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DerivaMLException</span><span class="p">(</span><span class="s2">&quot;No dataset RID provided&quot;</span><span class="p">)</span>

    <span class="c1"># Validate that this dataset exists in the bag</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rid_lookup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

    <span class="c1"># Cache the version and dataset table reference</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dataset_version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dataset_table</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.__repr__" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">__repr__</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">__repr__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a string representation of the DatasetBag for debugging.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string representation of the DatasetBag for debugging.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;deriva_ml.DatasetBag object at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="si">}</span><span class="s2">: rid=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;version=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_version</span><span class="si">}</span><span class="s2">&#39;, types=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_types</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.dataset_history" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">dataset_history</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">dataset_history</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span>
    <span class="n">DatasetHistory</span>
<span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Retrieves the version history of a dataset.</p>
<p>Returns a chronological list of dataset versions, including their version numbers,
creation times, and associated metadata.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<a class="autorefs autorefs-internal" title="DatasetHistory (deriva_ml.dataset.aux_classes.DatasetHistory)" href="../dataset_aux_classes/#deriva_ml.dataset.aux_classes.DatasetHistory">DatasetHistory</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[DatasetHistory]: List of history entries, each containing:
- dataset_version: Version number (major.minor.patch)
- minid: Minimal Viable Identifier
- snapshot: Catalog snapshot time
- dataset_rid: Dataset Resource Identifier
- version_rid: Version Resource Identifier
- description: Version description
- execution_rid: Associated execution RID</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="DerivaMLException (deriva_ml.core.exceptions.DerivaMLException)" href="../exceptions/#deriva_ml.core.exceptions.DerivaMLException">DerivaMLException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If dataset_rid is not a valid dataset RID.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>history = ml.dataset_history("1-abc123")
for entry in history:
...     print(f"Version {entry.dataset_version}: {entry.description}")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dataset_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">DatasetHistory</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves the version history of a dataset.</span>

<span class="sd">    Returns a chronological list of dataset versions, including their version numbers,</span>
<span class="sd">    creation times, and associated metadata.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[DatasetHistory]: List of history entries, each containing:</span>
<span class="sd">            - dataset_version: Version number (major.minor.patch)</span>
<span class="sd">            - minid: Minimal Viable Identifier</span>
<span class="sd">            - snapshot: Catalog snapshot time</span>
<span class="sd">            - dataset_rid: Dataset Resource Identifier</span>
<span class="sd">            - version_rid: Version Resource Identifier</span>
<span class="sd">            - description: Version description</span>
<span class="sd">            - execution_rid: Associated execution RID</span>

<span class="sd">    Raises:</span>
<span class="sd">        DerivaMLException: If dataset_rid is not a valid dataset RID.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; history = ml.dataset_history(&quot;1-abc123&quot;)</span>
<span class="sd">        &gt;&gt;&gt; for entry in history:</span>
<span class="sd">        ...     print(f&quot;Version {entry.dataset_version}: {entry.description}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Query Dataset_Version table directly via the model</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">DatasetHistory</span><span class="p">(</span>
            <span class="n">dataset_version</span><span class="o">=</span><span class="n">DatasetVersion</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Version&quot;</span><span class="p">]),</span>
            <span class="n">minid</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Minid&quot;</span><span class="p">],</span>
            <span class="n">snapshot</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Snapshot&quot;</span><span class="p">],</span>
            <span class="n">dataset_rid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">,</span>
            <span class="n">version_rid</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">],</span>
            <span class="n">description</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Description&quot;</span><span class="p">],</span>
            <span class="n">execution_rid</span><span class="o">=</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;Execution&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_get_table_contents</span><span class="p">(</span><span class="s2">&quot;Dataset_Version&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span>
    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.denormalize_as_dataframe" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">denormalize_as_dataframe</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">denormalize_as_dataframe</span><span class="p">(</span>
    <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Denormalize the dataset bag into a single wide table (DataFrame).</p>
<p>Denormalization transforms normalized relational data into a single "wide table"
(also called a "flat table" or "denormalized table") by joining related tables
together. This produces a DataFrame where each row contains all related information
from multiple source tables, with columns from each table combined side-by-side.</p>
<p>Wide tables are the standard input format for most machine learning frameworks,
which expect all features for a single observation to be in one row. This method
bridges the gap between normalized database schemas and ML-ready tabular data.</p>
<p><strong>How it works:</strong></p>
<p>Tables are joined based on their foreign key relationships stored in the bag's
schema. For example, if Image has a foreign key to Subject, denormalizing
["Subject", "Image"] produces rows where each image appears with its subject's
metadata.</p>
<p><strong>Column naming:</strong></p>
<p>Column names are prefixed with the source table name using dots to avoid
collisions (e.g., "Image.Filename", "Subject.RID"). This differs from the
live Dataset class which uses underscores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>include_tables</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of table names to include in the output. Tables
are joined based on their foreign key relationships.
Order doesn't matter - the join order is determined automatically.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored (bags are immutable snapshots of a specific version).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (ignored, for protocol compatibility).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pd.DataFrame: Wide table with columns from all included tables.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Create a training dataset from a downloaded bag::</p>
<pre><code>&gt;&gt;&gt; # Download and materialize the dataset
&gt;&gt;&gt; bag = ml.download_dataset_bag(spec, materialize=True)

&gt;&gt;&gt; # Denormalize into a wide table
&gt;&gt;&gt; df = bag.denormalize_as_dataframe(["Image", "Diagnosis"])
&gt;&gt;&gt; print(df.columns.tolist())
['Image.RID', 'Image.Filename', 'Image.URL', 'Diagnosis.RID',
 'Diagnosis.Label', 'Diagnosis.Confidence']

&gt;&gt;&gt; # Access local file paths for images
&gt;&gt;&gt; for _, row in df.iterrows():
...     local_path = bag.get_asset_path("Image", row["Image.RID"])
...     label = row["Diagnosis.Label"]
...     # Train on local_path with label
</code></pre>
</details>

<details class="see-also" open>
  <summary>See Also</summary>
  <p>denormalize_as_dict: Generator version for memory-efficient processing.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">denormalize_as_dataframe</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Denormalize the dataset bag into a single wide table (DataFrame).</span>

<span class="sd">    Denormalization transforms normalized relational data into a single &quot;wide table&quot;</span>
<span class="sd">    (also called a &quot;flat table&quot; or &quot;denormalized table&quot;) by joining related tables</span>
<span class="sd">    together. This produces a DataFrame where each row contains all related information</span>
<span class="sd">    from multiple source tables, with columns from each table combined side-by-side.</span>

<span class="sd">    Wide tables are the standard input format for most machine learning frameworks,</span>
<span class="sd">    which expect all features for a single observation to be in one row. This method</span>
<span class="sd">    bridges the gap between normalized database schemas and ML-ready tabular data.</span>

<span class="sd">    **How it works:**</span>

<span class="sd">    Tables are joined based on their foreign key relationships stored in the bag&#39;s</span>
<span class="sd">    schema. For example, if Image has a foreign key to Subject, denormalizing</span>
<span class="sd">    [&quot;Subject&quot;, &quot;Image&quot;] produces rows where each image appears with its subject&#39;s</span>
<span class="sd">    metadata.</span>

<span class="sd">    **Column naming:**</span>

<span class="sd">    Column names are prefixed with the source table name using dots to avoid</span>
<span class="sd">    collisions (e.g., &quot;Image.Filename&quot;, &quot;Subject.RID&quot;). This differs from the</span>
<span class="sd">    live Dataset class which uses underscores.</span>

<span class="sd">    Args:</span>
<span class="sd">        include_tables: List of table names to include in the output. Tables</span>
<span class="sd">            are joined based on their foreign key relationships.</span>
<span class="sd">            Order doesn&#39;t matter - the join order is determined automatically.</span>
<span class="sd">        version: Ignored (bags are immutable snapshots of a specific version).</span>
<span class="sd">        **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Wide table with columns from all included tables.</span>

<span class="sd">    Example:</span>
<span class="sd">        Create a training dataset from a downloaded bag::</span>

<span class="sd">            &gt;&gt;&gt; # Download and materialize the dataset</span>
<span class="sd">            &gt;&gt;&gt; bag = ml.download_dataset_bag(spec, materialize=True)</span>

<span class="sd">            &gt;&gt;&gt; # Denormalize into a wide table</span>
<span class="sd">            &gt;&gt;&gt; df = bag.denormalize_as_dataframe([&quot;Image&quot;, &quot;Diagnosis&quot;])</span>
<span class="sd">            &gt;&gt;&gt; print(df.columns.tolist())</span>
<span class="sd">            [&#39;Image.RID&#39;, &#39;Image.Filename&#39;, &#39;Image.URL&#39;, &#39;Diagnosis.RID&#39;,</span>
<span class="sd">             &#39;Diagnosis.Label&#39;, &#39;Diagnosis.Confidence&#39;]</span>

<span class="sd">            &gt;&gt;&gt; # Access local file paths for images</span>
<span class="sd">            &gt;&gt;&gt; for _, row in df.iterrows():</span>
<span class="sd">            ...     local_path = bag.get_asset_path(&quot;Image&quot;, row[&quot;Image.RID&quot;])</span>
<span class="sd">            ...     label = row[&quot;Diagnosis.Label&quot;]</span>
<span class="sd">            ...     # Train on local_path with label</span>

<span class="sd">    See Also:</span>
<span class="sd">        denormalize_as_dict: Generator version for memory-efficient processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_from_members</span><span class="p">(</span><span class="n">include_tables</span><span class="o">=</span><span class="n">include_tables</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.denormalize_as_dict" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">denormalize_as_dict</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">denormalize_as_dict</span><span class="p">(</span>
    <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span>
    <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Denormalize the dataset bag and yield rows as dictionaries.</p>
<p>This is a memory-efficient alternative to denormalize_as_dataframe() that
yields one row at a time as a dictionary instead of loading all data into
a DataFrame. Use this when processing large datasets that may not fit in
memory, or when you want to process rows incrementally.</p>
<p>Like denormalize_as_dataframe(), this produces a "wide table" representation
where each yielded dictionary contains all columns from the joined tables.
See denormalize_as_dataframe() for detailed explanation of how denormalization
works.</p>
<p><strong>Column naming:</strong></p>
<p>Column names are prefixed with the source table name using dots to avoid
collisions (e.g., "Image.Filename", "Subject.RID"). This differs from the
live Dataset class which uses underscores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>include_tables</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of table names to include in the output.
Tables are joined based on their foreign key relationships.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored (bags are immutable snapshots of a specific version).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (ignored, for protocol compatibility).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, Any]: Dictionary representing one row of the wide table.
Keys are column names in "Table.Column" format.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Stream through a large dataset for training::</p>
<pre><code>&gt;&gt;&gt; bag = ml.download_dataset_bag(spec, materialize=True)
&gt;&gt;&gt; for row in bag.denormalize_as_dict(["Image", "Diagnosis"]):
...     # Get local file path for this image
...     local_path = bag.get_asset_path("Image", row["Image.RID"])
...     label = row["Diagnosis.Label"]
...     # Process image and label...
</code></pre>
<p>Build a PyTorch dataset efficiently::</p>
<pre><code>&gt;&gt;&gt; class BagDataset(torch.utils.data.IterableDataset):
...     def __init__(self, bag, tables):
...         self.bag = bag
...         self.tables = tables
...     def __iter__(self):
...         for row in self.bag.denormalize_as_dict(self.tables):
...             img_path = self.bag.get_asset_path("Image", row["Image.RID"])
...             yield load_image(img_path), row["Diagnosis.Label"]
</code></pre>
</details>

<details class="see-also" open>
  <summary>See Also</summary>
  <p>denormalize_as_dataframe: Returns all data as a pandas DataFrame.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">denormalize_as_dict</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Denormalize the dataset bag and yield rows as dictionaries.</span>

<span class="sd">    This is a memory-efficient alternative to denormalize_as_dataframe() that</span>
<span class="sd">    yields one row at a time as a dictionary instead of loading all data into</span>
<span class="sd">    a DataFrame. Use this when processing large datasets that may not fit in</span>
<span class="sd">    memory, or when you want to process rows incrementally.</span>

<span class="sd">    Like denormalize_as_dataframe(), this produces a &quot;wide table&quot; representation</span>
<span class="sd">    where each yielded dictionary contains all columns from the joined tables.</span>
<span class="sd">    See denormalize_as_dataframe() for detailed explanation of how denormalization</span>
<span class="sd">    works.</span>

<span class="sd">    **Column naming:**</span>

<span class="sd">    Column names are prefixed with the source table name using dots to avoid</span>
<span class="sd">    collisions (e.g., &quot;Image.Filename&quot;, &quot;Subject.RID&quot;). This differs from the</span>
<span class="sd">    live Dataset class which uses underscores.</span>

<span class="sd">    Args:</span>
<span class="sd">        include_tables: List of table names to include in the output.</span>
<span class="sd">            Tables are joined based on their foreign key relationships.</span>
<span class="sd">        version: Ignored (bags are immutable snapshots of a specific version).</span>
<span class="sd">        **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">    Yields:</span>
<span class="sd">        dict[str, Any]: Dictionary representing one row of the wide table.</span>
<span class="sd">            Keys are column names in &quot;Table.Column&quot; format.</span>

<span class="sd">    Example:</span>
<span class="sd">        Stream through a large dataset for training::</span>

<span class="sd">            &gt;&gt;&gt; bag = ml.download_dataset_bag(spec, materialize=True)</span>
<span class="sd">            &gt;&gt;&gt; for row in bag.denormalize_as_dict([&quot;Image&quot;, &quot;Diagnosis&quot;]):</span>
<span class="sd">            ...     # Get local file path for this image</span>
<span class="sd">            ...     local_path = bag.get_asset_path(&quot;Image&quot;, row[&quot;Image.RID&quot;])</span>
<span class="sd">            ...     label = row[&quot;Diagnosis.Label&quot;]</span>
<span class="sd">            ...     # Process image and label...</span>

<span class="sd">        Build a PyTorch dataset efficiently::</span>

<span class="sd">            &gt;&gt;&gt; class BagDataset(torch.utils.data.IterableDataset):</span>
<span class="sd">            ...     def __init__(self, bag, tables):</span>
<span class="sd">            ...         self.bag = bag</span>
<span class="sd">            ...         self.tables = tables</span>
<span class="sd">            ...     def __iter__(self):</span>
<span class="sd">            ...         for row in self.bag.denormalize_as_dict(self.tables):</span>
<span class="sd">            ...             img_path = self.bag.get_asset_path(&quot;Image&quot;, row[&quot;Image.RID&quot;])</span>
<span class="sd">            ...             yield load_image(img_path), row[&quot;Diagnosis.Label&quot;]</span>

<span class="sd">    See Also:</span>
<span class="sd">        denormalize_as_dataframe: Returns all data as a pandas DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_denormalize_from_members</span><span class="p">(</span><span class="n">include_tables</span><span class="o">=</span><span class="n">include_tables</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.find_features" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">find_features</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">find_features</span><span class="p">(</span>
    <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Table</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Feature</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Find features for a table.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="str">str</span> | <span title="deriva.core.ermrest_model.Table">Table</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The table to find features for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<a class="autorefs autorefs-internal" title="Feature (deriva_ml.feature.Feature)" href="../feature/#deriva_ml.feature.Feature">Feature</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An iterable of Feature instances.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">find_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Feature</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find features for a table.</span>

<span class="sd">    Args:</span>
<span class="sd">        table: The table to find features for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An iterable of Feature instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_features</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.get_table_as_dict" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">get_table_as_dict</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_table_as_dict</span><span class="p">(</span>
    <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span>
    <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get table contents as dictionaries.</p>
<p>Convenience method that delegates to the underlying catalog. This provides
access to all rows in a table, not just those belonging to this dataset.
For dataset-filtered results, use list_dataset_members() instead.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the table to retrieve (e.g., "Subject", "Image").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary for each row in the table.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>for subject in bag.get_table_as_dict("Subject"):
...     print(subject["Name"])</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_table_as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get table contents as dictionaries.</span>

<span class="sd">    Convenience method that delegates to the underlying catalog. This provides</span>
<span class="sd">    access to all rows in a table, not just those belonging to this dataset.</span>
<span class="sd">    For dataset-filtered results, use list_dataset_members() instead.</span>

<span class="sd">    Args:</span>
<span class="sd">        table: Name of the table to retrieve (e.g., &quot;Subject&quot;, &quot;Image&quot;).</span>

<span class="sd">    Yields:</span>
<span class="sd">        dict: Dictionary for each row in the table.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; for subject in bag.get_table_as_dict(&quot;Subject&quot;):</span>
<span class="sd">        ...     print(subject[&quot;Name&quot;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">get_table_as_dict</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_children" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">list_dataset_children</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_dataset_children</span><span class="p">(</span>
    <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get nested datasets.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>recurse</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include children of children.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>_visited</code>
            </td>
            <td>
                  <code><span title="set">set</span>[<span title="deriva_ml.core.definitions.RID">RID</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Internal parameter to track visited datasets and prevent infinite recursion.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored (bags are immutable snapshots).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (ignored, for protocol compatibility).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="typing.Self">Self</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of child dataset bags.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_children</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get nested datasets.</span>

<span class="sd">    Args:</span>
<span class="sd">        recurse: Whether to include children of children.</span>
<span class="sd">        _visited: Internal parameter to track visited datasets and prevent infinite recursion.</span>
<span class="sd">        version: Ignored (bags are immutable snapshots).</span>
<span class="sd">        **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of child dataset bags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize visited set for recursion guard</span>
    <span class="k">if</span> <span class="n">_visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Prevent infinite recursion by checking if we&#39;ve already visited this dataset</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">_visited</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">_visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

    <span class="n">ds_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset&quot;</span><span class="p">)</span>
    <span class="n">nds_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Dataset&quot;</span><span class="p">)</span>
    <span class="n">dv_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Version&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">sql_cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Nested_Dataset</span><span class="p">,</span> <span class="n">dv_table</span><span class="o">.</span><span class="n">Version</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">ds_table</span><span class="p">,</span> <span class="n">nds_table</span><span class="p">,</span> <span class="n">onclause</span><span class="o">=</span><span class="n">ds_table</span><span class="o">.</span><span class="n">RID</span> <span class="o">==</span> <span class="n">nds_table</span><span class="o">.</span><span class="n">Nested_Dataset</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">ds_table</span><span class="p">,</span> <span class="n">dv_table</span><span class="p">,</span> <span class="n">onclause</span><span class="o">=</span><span class="n">ds_table</span><span class="o">.</span><span class="n">Version</span> <span class="o">==</span> <span class="n">dv_table</span><span class="o">.</span><span class="n">RID</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">nested</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">lookup_dataset</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">nested</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">nested</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">list_dataset_children</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">_visited</span><span class="o">=</span><span class="n">_visited</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_element_types" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">list_dataset_element_types</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_dataset_element_types</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
    <span class="n">Iterable</span><span class="p">[</span><span class="n">Table</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>List the types of elements that can be contained in datasets.</p>
<p>This method analyzes the dataset and identifies the data types for all
elements within it. It is useful for understanding the structure and
content of the dataset and allows for better manipulation and usage of its
data.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<span title="deriva.core.ermrest_model.Table">Table</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]: A list of strings where each string represents a data type</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<span title="deriva.core.ermrest_model.Table">Table</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>of an element found in the dataset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_element_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Table</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List the types of elements that can be contained in datasets.</span>

<span class="sd">    This method analyzes the dataset and identifies the data types for all</span>
<span class="sd">    elements within it. It is useful for understanding the structure and</span>
<span class="sd">    content of the dataset and allows for better manipulation and usage of its</span>
<span class="sd">    data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[str]: A list of strings where each string represents a data type</span>
<span class="sd">        of an element found in the dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_dataset_element_types</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_members" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">list_dataset_members</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_dataset_members</span><span class="p">(</span>
    <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Return a list of entities associated with a specific dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>recurse</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to include members of nested datasets.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of members to return per type. None for no limit.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>_visited</code>
            </td>
            <td>
                  <code><span title="set">set</span>[<span title="deriva_ml.core.definitions.RID">RID</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Internal parameter to track visited datasets and prevent infinite recursion.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored (bags are immutable snapshots).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (ignored, for protocol compatibility).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping member types to lists of member records.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_members</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a list of entities associated with a specific dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        recurse: Whether to include members of nested datasets.</span>
<span class="sd">        limit: Maximum number of members to return per type. None for no limit.</span>
<span class="sd">        _visited: Internal parameter to track visited datasets and prevent infinite recursion.</span>
<span class="sd">        version: Ignored (bags are immutable snapshots).</span>
<span class="sd">        **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping member types to lists of member records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize visited set for recursion guard</span>
    <span class="k">if</span> <span class="n">_visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Prevent infinite recursion by checking if we&#39;ve already visited this dataset</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">_visited</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">_visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

    <span class="c1"># Look at each of the element types that might be in the _dataset_table and get the list of rid for them from</span>
    <span class="c1"># the appropriate association table.</span>
    <span class="n">members</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="n">dataset_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_for_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">element_table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_dataset_element_types</span><span class="p">():</span>
        <span class="n">element_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_for_table</span><span class="p">(</span><span class="n">element_table</span><span class="p">)</span>

        <span class="n">assoc_class</span><span class="p">,</span> <span class="n">dataset_rel</span><span class="p">,</span> <span class="n">element_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_association_class</span><span class="p">(</span><span class="n">dataset_class</span><span class="p">,</span> <span class="n">element_class</span><span class="p">)</span>

        <span class="n">element_table</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">element_class</span><span class="p">)</span><span class="o">.</span><span class="n">mapped_table</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">is_domain_schema</span><span class="p">(</span><span class="n">element_table</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span> <span class="ow">and</span> <span class="n">element_table</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="s2">&quot;File&quot;</span><span class="p">]:</span>
            <span class="c1"># Look at domain tables and nested datasets.</span>
            <span class="k">continue</span>

        <span class="c1"># Get the names of the columns that we are going to need for linking</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="c1"># For Dataset_Dataset, use Nested_Dataset column to find nested datasets</span>
            <span class="c1"># (similar to how the live catalog does it in Dataset.list_dataset_members)</span>
            <span class="k">if</span> <span class="n">element_table</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span>
                <span class="n">sql_cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">select</span><span class="p">(</span><span class="n">element_class</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">assoc_class</span><span class="p">,</span> <span class="n">element_class</span><span class="o">.</span><span class="n">RID</span> <span class="o">==</span> <span class="n">assoc_class</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;Nested_Dataset&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="o">==</span> <span class="n">assoc_class</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For other tables, use the original join via element_rel</span>
                <span class="n">sql_cmd</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">select</span><span class="p">(</span><span class="n">element_class</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">element_rel</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="o">==</span> <span class="n">assoc_class</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">sql_cmd</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="c1"># Get back the list of ORM entities and convert them to dictionaries.</span>
            <span class="n">element_entities</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="n">element_rows</span> <span class="o">=</span> <span class="p">[{</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">element_entities</span><span class="p">]</span>
        <span class="n">members</span><span class="p">[</span><span class="n">element_table</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">element_rows</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recurse</span> <span class="ow">and</span> <span class="p">(</span><span class="n">element_table</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_table</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="c1"># Get the members for all the nested datasets and add to the member list.</span>
            <span class="n">nested_datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">element_rows</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">nested_datasets</span><span class="p">:</span>
                <span class="n">nested_dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">lookup_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nested_dataset</span><span class="o">.</span><span class="n">list_dataset_members</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">_visited</span><span class="o">=</span><span class="n">_visited</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">members</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">members</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_dataset_parents" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">list_dataset_parents</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_dataset_parents</span><span class="p">(</span>
    <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Given a dataset_table RID, return a list of RIDs of the parent datasets if this is included in a
nested dataset.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>recurse</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, recursively return all ancestor datasets.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>_visited</code>
            </td>
            <td>
                  <code><span title="set">set</span>[<span title="deriva_ml.core.definitions.RID">RID</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Internal parameter to track visited datasets and prevent infinite recursion.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ignored (bags are immutable snapshots).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments (ignored, for protocol compatibility).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="typing.Self">Self</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of parent dataset bags.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_dataset_parents</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">_visited</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">version</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a dataset_table RID, return a list of RIDs of the parent datasets if this is included in a</span>
<span class="sd">    nested dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        recurse: If True, recursively return all ancestor datasets.</span>
<span class="sd">        _visited: Internal parameter to track visited datasets and prevent infinite recursion.</span>
<span class="sd">        version: Ignored (bags are immutable snapshots).</span>
<span class="sd">        **kwargs: Additional arguments (ignored, for protocol compatibility).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of parent dataset bags.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize visited set for recursion guard</span>
    <span class="k">if</span> <span class="n">_visited</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Prevent infinite recursion by checking if we&#39;ve already visited this dataset</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span> <span class="ow">in</span> <span class="n">_visited</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">_visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>

    <span class="n">nds_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Dataset&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nds_table</span><span class="o">.</span><span class="n">Nested_Dataset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_catalog</span><span class="o">.</span><span class="n">lookup_dataset</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="n">parents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">list_dataset_parents</span><span class="p">(</span><span class="n">recurse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_visited</span><span class="o">=</span><span class="n">_visited</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">parents</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_executions" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">list_executions</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_executions</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">RID</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>List all execution RIDs associated with this dataset.</p>
<p>Returns all executions that used this dataset as input. This is
tracked through the Dataset_Execution association table.</p>


<details class="note" open>
  <summary>Note</summary>
  <p>Unlike the live Dataset class which returns Execution objects,
DatasetBag returns a list of execution RIDs since the bag is
an offline snapshot and cannot look up live execution objects.</p>
</details>

    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="deriva_ml.core.definitions.RID">RID</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of execution RIDs associated with this dataset.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>bag = ml.download_dataset_bag(dataset_spec)
execution_rids = bag.list_executions()
for rid in execution_rids:
...     print(f"Associated execution: {rid}")</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_executions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">RID</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all execution RIDs associated with this dataset.</span>

<span class="sd">    Returns all executions that used this dataset as input. This is</span>
<span class="sd">    tracked through the Dataset_Execution association table.</span>

<span class="sd">    Note:</span>
<span class="sd">        Unlike the live Dataset class which returns Execution objects,</span>
<span class="sd">        DatasetBag returns a list of execution RIDs since the bag is</span>
<span class="sd">        an offline snapshot and cannot look up live execution objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of execution RIDs associated with this dataset.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; bag = ml.download_dataset_bag(dataset_spec)</span>
<span class="sd">        &gt;&gt;&gt; execution_rids = bag.list_executions()</span>
<span class="sd">        &gt;&gt;&gt; for rid in execution_rids:</span>
<span class="sd">        ...     print(f&quot;Associated execution: {rid}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">de_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_orm_class_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ml_schema</span><span class="si">}</span><span class="s2">.Dataset_Execution&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">de_table</span><span class="o">.</span><span class="n">Execution</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">de_table</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_rid</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">list_feature_values</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_feature_values</span><span class="p">(</span>
    <span class="n">table</span><span class="p">:</span> <span class="n">Table</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">FeatureRecord</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Retrieves all values for a feature as typed FeatureRecord instances.</p>
<p>Returns an iterator of dynamically-generated FeatureRecord objects for each
feature value. Each record is an instance of a Pydantic model specific to
this feature, with typed attributes for all columns including the Execution
that created the feature value.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
                  <code><span title="deriva.core.ermrest_model.Table">Table</span> | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The table containing the feature, either as name or Table object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>feature_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the feature to retrieve values for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Iterable">Iterable</span>[<a class="autorefs autorefs-internal" title="FeatureRecord (deriva_ml.feature.FeatureRecord)" href="../feature/#deriva_ml.feature.FeatureRecord">FeatureRecord</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Iterable[FeatureRecord]: An iterator of FeatureRecord instances.
Each instance has:
- Execution: RID of the execution that created this feature value
- Feature_Name: Name of the feature
- All feature-specific columns as typed attributes
- model_dump() method to convert back to a dictionary</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="DerivaMLException (deriva_ml.core.exceptions.DerivaMLException)" href="../exceptions/#deriva_ml.core.exceptions.DerivaMLException">DerivaMLException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the feature doesn't exist or cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<h4 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values--get-typed-feature-records">Get typed feature records</h4>
<p>for record in bag.list_feature_values("Image", "Quality"):
...     print(f"Image {record.Image}: {record.ImageQuality}")
...     print(f"Created by execution: {record.Execution}")</p>
<h4 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_feature_values--convert-records-to-dictionaries">Convert records to dictionaries</h4>
<p>records = list(bag.list_feature_values("Image", "Quality"))
dicts = [r.model_dump() for r in records]</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_feature_values</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">FeatureRecord</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves all values for a feature as typed FeatureRecord instances.</span>

<span class="sd">    Returns an iterator of dynamically-generated FeatureRecord objects for each</span>
<span class="sd">    feature value. Each record is an instance of a Pydantic model specific to</span>
<span class="sd">    this feature, with typed attributes for all columns including the Execution</span>
<span class="sd">    that created the feature value.</span>

<span class="sd">    Args:</span>
<span class="sd">        table: The table containing the feature, either as name or Table object.</span>
<span class="sd">        feature_name: Name of the feature to retrieve values for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Iterable[FeatureRecord]: An iterator of FeatureRecord instances.</span>
<span class="sd">            Each instance has:</span>
<span class="sd">            - Execution: RID of the execution that created this feature value</span>
<span class="sd">            - Feature_Name: Name of the feature</span>
<span class="sd">            - All feature-specific columns as typed attributes</span>
<span class="sd">            - model_dump() method to convert back to a dictionary</span>

<span class="sd">    Raises:</span>
<span class="sd">        DerivaMLException: If the feature doesn&#39;t exist or cannot be accessed.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # Get typed feature records</span>
<span class="sd">        &gt;&gt;&gt; for record in bag.list_feature_values(&quot;Image&quot;, &quot;Quality&quot;):</span>
<span class="sd">        ...     print(f&quot;Image {record.Image}: {record.ImageQuality}&quot;)</span>
<span class="sd">        ...     print(f&quot;Created by execution: {record.Execution}&quot;)</span>

<span class="sd">        &gt;&gt;&gt; # Convert records to dictionaries</span>
<span class="sd">        &gt;&gt;&gt; records = list(bag.list_feature_values(&quot;Image&quot;, &quot;Quality&quot;))</span>
<span class="sd">        &gt;&gt;&gt; dicts = [r.model_dump() for r in records]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get table and feature</span>
    <span class="n">feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">lookup_feature</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">)</span>

    <span class="c1"># Get the dynamically-generated FeatureRecord subclass for this feature</span>
    <span class="n">record_class</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">feature_record_class</span><span class="p">()</span>

    <span class="c1"># Query raw values from SQLite</span>
    <span class="n">feature_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">find_table</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">feature_table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">sql_cmd</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">feature_table</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_cmd</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">_mapping</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>

    <span class="c1"># Convert to typed records</span>
    <span class="k">for</span> <span class="n">raw_value</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="c1"># Filter to only include fields that the record class expects</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">record_class</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_value</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">}</span>
        <span class="k">yield</span> <span class="n">record_class</span><span class="p">(</span><span class="o">**</span><span class="n">filtered_data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.list_tables" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">list_tables</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">list_tables</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>List all tables available in the bag's SQLite database.</p>
<p>Returns the fully-qualified names of all tables (e.g., "domain.Image",
"deriva-ml.Dataset") that were exported in this bag.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list[str]: Table names in "schema.table" format, sorted alphabetically.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all tables available in the bag&#39;s SQLite database.</span>

<span class="sd">    Returns the fully-qualified names of all tables (e.g., &quot;domain.Image&quot;,</span>
<span class="sd">    &quot;deriva-ml.Dataset&quot;) that were exported in this bag.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[str]: Table names in &quot;schema.table&quot; format, sorted alphabetically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">list_tables</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="deriva_ml.dataset.dataset_bag.DatasetBag.restructure_assets" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">restructure_assets</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">restructure_assets</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">asset_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">group_by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_symlinks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">type_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span>
    <span class="p">]</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">type_to_dir_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enforce_vocabulary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">value_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
        <span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">FeatureValueRecord</span><span class="p">]],</span>
        <span class="n">FeatureValueRecord</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Restructure downloaded assets into a directory hierarchy.</p>
<p>Creates a directory structure organizing assets by dataset types and
grouping values. This is useful for ML workflows that expect data
organized in conventional folder structures (e.g., PyTorch ImageFolder).</p>
<p>The dataset should be of type Training or Testing, or have nested
children of those types. The top-level directory name is determined
by the dataset type (e.g., "Training" -&gt; "training").</p>
<p><strong>Finding assets through foreign key relationships:</strong></p>
<p>Assets are found by traversing all foreign key paths from the dataset,
not just direct associations. For example, if a dataset contains Subjects,
and the schema has Subject -&gt; Encounter -&gt; Image relationships, this method
will find all Images reachable through those paths even though they are
not directly in a Dataset_Image association table.</p>
<p><strong>Handling datasets without types (prediction scenarios):</strong></p>
<p>If a dataset has no type defined, it is treated as Testing. This is
common for prediction/inference scenarios where you want to apply a
trained model to new unlabeled data.</p>
<p><strong>Handling missing labels:</strong></p>
<p>If an asset doesn't have a value for a group_by key (e.g., no label
assigned), it is placed in an "Unknown" directory. This allows
restructure_assets to work with unlabeled data for prediction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Base directory for restructured assets.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>asset_table</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the asset table (e.g., "Image"). If None,
auto-detects from dataset members. Raises DerivaMLException
if multiple asset tables are found and none is specified.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>group_by</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Names to group assets by. Each name creates a subdirectory
level after the dataset type path. Names can be:</p>
<ul>
<li><strong>Column names</strong>: Direct columns on the asset table. The column
  value becomes the subdirectory name.</li>
<li><strong>Feature names</strong>: Features defined on the asset table (or tables
  it references via foreign keys). The feature's vocabulary term
  value becomes the subdirectory name.</li>
<li><strong>Feature.column</strong>: Specify a particular column from a multi-term
  feature (e.g., "Classification.Label" to use the Label column).</li>
</ul>
<p>Column names are checked first, then feature names. If a value
is not found, "unknown" is used as the subdirectory name.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_symlinks</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), create symlinks to original files.
If False, copy files. Symlinks save disk space but require
the original bag to remain in place.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>type_selector</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="list">list</span>[<span title="str">str</span>]], <span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to select type when dataset has multiple types.
Receives list of type names, returns selected type name.
Defaults to selecting first type or "unknown" if no types.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>type_to_dir_map</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional mapping from dataset type names to directory
names. Defaults to {"Training": "training", "Testing": "testing",
"Unknown": "unknown"}. Use this to customize directory names or
add new type mappings.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enforce_vocabulary</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True (default), only allow features that have
controlled vocabulary term columns, and raise an error if an asset
has multiple different values for the same feature without a
value_selector. This ensures clean, unambiguous directory structures.
If False, allow any feature type and use the first value found
when multiple values exist.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value_selector</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="list">list</span>[<a class="autorefs autorefs-internal" title="FeatureValueRecord


  
      dataclass
   (deriva_ml.dataset.dataset_bag.FeatureValueRecord)" href="#deriva_ml.dataset.dataset_bag.FeatureValueRecord">FeatureValueRecord</a>]], <a class="autorefs autorefs-internal" title="FeatureValueRecord


  
      dataclass
   (deriva_ml.dataset.dataset_bag.FeatureValueRecord)" href="#deriva_ml.dataset.dataset_bag.FeatureValueRecord">FeatureValueRecord</a>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional function to select which feature value to use
when an asset has multiple values for the same feature. Receives a
list of FeatureValueRecord objects (each containing target_rid,
feature_name, value, execution_rid, and raw_record) and returns
the selected FeatureValueRecord. Use execution_rid to distinguish
between values from different executions.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the output directory.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="DerivaMLException (deriva_ml.core.exceptions.DerivaMLException)" href="../exceptions/#deriva_ml.core.exceptions.DerivaMLException">DerivaMLException</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If asset_table cannot be determined (multiple
asset tables exist without specification), if no valid dataset
types (Training/Testing) are found, or if enforce_vocabulary
is True and a feature has multiple values without value_selector.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Basic restructuring with auto-detected asset table::</p>
<pre><code>bag.restructure_assets(
    output_dir="./ml_data",
    group_by=["Diagnosis"],
)
# Creates:
# ./ml_data/training/Normal/image1.jpg
# ./ml_data/testing/Abnormal/image2.jpg
</code></pre>
<p>Custom type-to-directory mapping::</p>
<pre><code>bag.restructure_assets(
    output_dir="./ml_data",
    group_by=["Diagnosis"],
    type_to_dir_map={"Training": "train", "Testing": "test"},
)
# Creates:
# ./ml_data/train/Normal/image1.jpg
# ./ml_data/test/Abnormal/image2.jpg
</code></pre>
<p>Select specific feature column for multi-term features::</p>
<pre><code>bag.restructure_assets(
    output_dir="./ml_data",
    group_by=["Classification.Label"],  # Use Label column
)
</code></pre>
<p>Handle multiple feature values with a selector::</p>
<pre><code>def select_latest(records: list[FeatureValueRecord]) -&gt; FeatureValueRecord:
    # Select value from most recent execution
    return max(records, key=lambda r: r.execution_rid or "")

bag.restructure_assets(
    output_dir="./ml_data",
    group_by=["Diagnosis"],
    value_selector=select_latest,
)
</code></pre>
<p>Prediction scenario with unlabeled data::</p>
<pre><code># Dataset has no type - treated as Testing
# Assets have no labels - placed in Unknown directory
bag.restructure_assets(
    output_dir="./prediction_data",
    group_by=["Diagnosis"],
)
# Creates:
# ./prediction_data/testing/Unknown/image1.jpg
# ./prediction_data/testing/Unknown/image2.jpg
</code></pre>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">restructure_assets</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">asset_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">group_by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_symlinks</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">type_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">type_to_dir_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">enforce_vocabulary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">value_selector</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">list</span><span class="p">[</span><span class="n">FeatureValueRecord</span><span class="p">]],</span> <span class="n">FeatureValueRecord</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Restructure downloaded assets into a directory hierarchy.</span>

<span class="sd">    Creates a directory structure organizing assets by dataset types and</span>
<span class="sd">    grouping values. This is useful for ML workflows that expect data</span>
<span class="sd">    organized in conventional folder structures (e.g., PyTorch ImageFolder).</span>

<span class="sd">    The dataset should be of type Training or Testing, or have nested</span>
<span class="sd">    children of those types. The top-level directory name is determined</span>
<span class="sd">    by the dataset type (e.g., &quot;Training&quot; -&gt; &quot;training&quot;).</span>

<span class="sd">    **Finding assets through foreign key relationships:**</span>

<span class="sd">    Assets are found by traversing all foreign key paths from the dataset,</span>
<span class="sd">    not just direct associations. For example, if a dataset contains Subjects,</span>
<span class="sd">    and the schema has Subject -&gt; Encounter -&gt; Image relationships, this method</span>
<span class="sd">    will find all Images reachable through those paths even though they are</span>
<span class="sd">    not directly in a Dataset_Image association table.</span>

<span class="sd">    **Handling datasets without types (prediction scenarios):**</span>

<span class="sd">    If a dataset has no type defined, it is treated as Testing. This is</span>
<span class="sd">    common for prediction/inference scenarios where you want to apply a</span>
<span class="sd">    trained model to new unlabeled data.</span>

<span class="sd">    **Handling missing labels:**</span>

<span class="sd">    If an asset doesn&#39;t have a value for a group_by key (e.g., no label</span>
<span class="sd">    assigned), it is placed in an &quot;Unknown&quot; directory. This allows</span>
<span class="sd">    restructure_assets to work with unlabeled data for prediction.</span>

<span class="sd">    Args:</span>
<span class="sd">        output_dir: Base directory for restructured assets.</span>
<span class="sd">        asset_table: Name of the asset table (e.g., &quot;Image&quot;). If None,</span>
<span class="sd">            auto-detects from dataset members. Raises DerivaMLException</span>
<span class="sd">            if multiple asset tables are found and none is specified.</span>
<span class="sd">        group_by: Names to group assets by. Each name creates a subdirectory</span>
<span class="sd">            level after the dataset type path. Names can be:</span>

<span class="sd">            - **Column names**: Direct columns on the asset table. The column</span>
<span class="sd">              value becomes the subdirectory name.</span>
<span class="sd">            - **Feature names**: Features defined on the asset table (or tables</span>
<span class="sd">              it references via foreign keys). The feature&#39;s vocabulary term</span>
<span class="sd">              value becomes the subdirectory name.</span>
<span class="sd">            - **Feature.column**: Specify a particular column from a multi-term</span>
<span class="sd">              feature (e.g., &quot;Classification.Label&quot; to use the Label column).</span>

<span class="sd">            Column names are checked first, then feature names. If a value</span>
<span class="sd">            is not found, &quot;unknown&quot; is used as the subdirectory name.</span>

<span class="sd">        use_symlinks: If True (default), create symlinks to original files.</span>
<span class="sd">            If False, copy files. Symlinks save disk space but require</span>
<span class="sd">            the original bag to remain in place.</span>
<span class="sd">        type_selector: Function to select type when dataset has multiple types.</span>
<span class="sd">            Receives list of type names, returns selected type name.</span>
<span class="sd">            Defaults to selecting first type or &quot;unknown&quot; if no types.</span>
<span class="sd">        type_to_dir_map: Optional mapping from dataset type names to directory</span>
<span class="sd">            names. Defaults to {&quot;Training&quot;: &quot;training&quot;, &quot;Testing&quot;: &quot;testing&quot;,</span>
<span class="sd">            &quot;Unknown&quot;: &quot;unknown&quot;}. Use this to customize directory names or</span>
<span class="sd">            add new type mappings.</span>
<span class="sd">        enforce_vocabulary: If True (default), only allow features that have</span>
<span class="sd">            controlled vocabulary term columns, and raise an error if an asset</span>
<span class="sd">            has multiple different values for the same feature without a</span>
<span class="sd">            value_selector. This ensures clean, unambiguous directory structures.</span>
<span class="sd">            If False, allow any feature type and use the first value found</span>
<span class="sd">            when multiple values exist.</span>
<span class="sd">        value_selector: Optional function to select which feature value to use</span>
<span class="sd">            when an asset has multiple values for the same feature. Receives a</span>
<span class="sd">            list of FeatureValueRecord objects (each containing target_rid,</span>
<span class="sd">            feature_name, value, execution_rid, and raw_record) and returns</span>
<span class="sd">            the selected FeatureValueRecord. Use execution_rid to distinguish</span>
<span class="sd">            between values from different executions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the output directory.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DerivaMLException: If asset_table cannot be determined (multiple</span>
<span class="sd">            asset tables exist without specification), if no valid dataset</span>
<span class="sd">            types (Training/Testing) are found, or if enforce_vocabulary</span>
<span class="sd">            is True and a feature has multiple values without value_selector.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Basic restructuring with auto-detected asset table::</span>

<span class="sd">            bag.restructure_assets(</span>
<span class="sd">                output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">            )</span>
<span class="sd">            # Creates:</span>
<span class="sd">            # ./ml_data/training/Normal/image1.jpg</span>
<span class="sd">            # ./ml_data/testing/Abnormal/image2.jpg</span>

<span class="sd">        Custom type-to-directory mapping::</span>

<span class="sd">            bag.restructure_assets(</span>
<span class="sd">                output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">                type_to_dir_map={&quot;Training&quot;: &quot;train&quot;, &quot;Testing&quot;: &quot;test&quot;},</span>
<span class="sd">            )</span>
<span class="sd">            # Creates:</span>
<span class="sd">            # ./ml_data/train/Normal/image1.jpg</span>
<span class="sd">            # ./ml_data/test/Abnormal/image2.jpg</span>

<span class="sd">        Select specific feature column for multi-term features::</span>

<span class="sd">            bag.restructure_assets(</span>
<span class="sd">                output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                group_by=[&quot;Classification.Label&quot;],  # Use Label column</span>
<span class="sd">            )</span>

<span class="sd">        Handle multiple feature values with a selector::</span>

<span class="sd">            def select_latest(records: list[FeatureValueRecord]) -&gt; FeatureValueRecord:</span>
<span class="sd">                # Select value from most recent execution</span>
<span class="sd">                return max(records, key=lambda r: r.execution_rid or &quot;&quot;)</span>

<span class="sd">            bag.restructure_assets(</span>
<span class="sd">                output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">                value_selector=select_latest,</span>
<span class="sd">            )</span>

<span class="sd">        Prediction scenario with unlabeled data::</span>

<span class="sd">            # Dataset has no type - treated as Testing</span>
<span class="sd">            # Assets have no labels - placed in Unknown directory</span>
<span class="sd">            bag.restructure_assets(</span>
<span class="sd">                output_dir=&quot;./prediction_data&quot;,</span>
<span class="sd">                group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">            )</span>
<span class="sd">            # Creates:</span>
<span class="sd">            # ./prediction_data/testing/Unknown/image1.jpg</span>
<span class="sd">            # ./prediction_data/testing/Unknown/image2.jpg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;deriva_ml&quot;</span><span class="p">)</span>
    <span class="n">group_by</span> <span class="o">=</span> <span class="n">group_by</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Default type-to-directory mapping</span>
    <span class="k">if</span> <span class="n">type_to_dir_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">type_to_dir_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Training&quot;</span><span class="p">:</span> <span class="s2">&quot;training&quot;</span><span class="p">,</span> <span class="s2">&quot;Testing&quot;</span><span class="p">:</span> <span class="s2">&quot;testing&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span>

    <span class="c1"># Auto-detect asset table if not provided</span>
    <span class="k">if</span> <span class="n">asset_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">asset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_asset_table</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">asset_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DerivaMLException</span><span class="p">(</span>
                <span class="s2">&quot;Could not auto-detect asset table. No asset tables found in dataset members. &quot;</span>
                <span class="s2">&quot;Specify the asset_table parameter explicitly.&quot;</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected asset table: </span><span class="si">{</span><span class="n">asset_table</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Step 1: Build dataset type path map with directory name mapping</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">map_type_to_dir</span><span class="p">(</span><span class="n">types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map dataset types to directory name using type_to_dir_map.</span>

<span class="sd">        If dataset has no types, treat it as Testing (prediction use case).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">types</span><span class="p">:</span>
            <span class="c1"># No types defined - treat as Testing for prediction scenarios</span>
            <span class="k">return</span> <span class="n">type_to_dir_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Testing&quot;</span><span class="p">,</span> <span class="s2">&quot;testing&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_selector</span><span class="p">:</span>
            <span class="n">selected_type</span> <span class="o">=</span> <span class="n">type_selector</span><span class="p">(</span><span class="n">types</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_type</span> <span class="o">=</span> <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">type_to_dir_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">selected_type</span><span class="p">,</span> <span class="n">selected_type</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="n">type_path_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_dataset_type_path_map</span><span class="p">(</span><span class="n">map_type_to_dir</span><span class="p">)</span>

    <span class="c1"># Step 2: Get asset-to-dataset mapping</span>
    <span class="n">asset_dataset_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_asset_dataset_mapping</span><span class="p">(</span><span class="n">asset_table</span><span class="p">)</span>

    <span class="c1"># Step 3: Load feature values cache for relevant features</span>
    <span class="n">feature_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_feature_values_cache</span><span class="p">(</span>
        <span class="n">asset_table</span><span class="p">,</span> <span class="n">group_by</span><span class="p">,</span> <span class="n">enforce_vocabulary</span><span class="p">,</span> <span class="n">value_selector</span>
    <span class="p">)</span>

    <span class="c1"># Step 4: Get all assets reachable through FK paths</span>
    <span class="c1"># This uses _get_reachable_assets which traverses FK relationships,</span>
    <span class="c1"># so assets connected via Subject -&gt; Encounter -&gt; Image are found</span>
    <span class="c1"># even if the dataset only contains Subjects directly.</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reachable_assets</span><span class="p">(</span><span class="n">asset_table</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">assets</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No assets found in table &#39;</span><span class="si">{</span><span class="n">asset_table</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output_dir</span>

    <span class="c1"># Step 5: Process each asset</span>
    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
        <span class="c1"># Get source file path</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Filename&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asset </span><span class="si">{</span><span class="n">asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RID&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> has no Filename&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">source_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asset file not found: </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Get dataset type path</span>
        <span class="n">dataset_rid</span> <span class="o">=</span> <span class="n">asset_dataset_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">asset</span><span class="p">[</span><span class="s2">&quot;RID&quot;</span><span class="p">])</span>
        <span class="n">type_path</span> <span class="o">=</span> <span class="n">type_path_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataset_rid</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;unknown&quot;</span><span class="p">])</span>

        <span class="c1"># Resolve grouping values</span>
        <span class="n">group_path</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">group_by</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_grouping_value</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">feature_cache</span><span class="p">)</span>
            <span class="n">group_path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Build target directory</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="o">*</span><span class="n">type_path</span><span class="p">,</span> <span class="o">*</span><span class="n">group_path</span><span class="p">)</span>
        <span class="n">target_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create link or copy</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">/</span> <span class="n">source_path</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Handle existing files</span>
        <span class="k">if</span> <span class="n">target_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">target_path</span><span class="o">.</span><span class="n">is_symlink</span><span class="p">():</span>
            <span class="n">target_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">use_symlinks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">source_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Fall back to copy on platforms that don&#39;t support symlinks</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symlink failed, falling back to copy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_dir</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="deriva_ml.dataset.dataset_bag.FeatureValueRecord" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">FeatureValueRecord</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



        <p>A feature value record with execution provenance.</p>
<p>This class represents a single feature value assigned to an asset,
including the execution that created it. Used by restructure_assets
when a value_selector function needs to choose between multiple
feature values for the same asset.</p>
<p>The raw_record attribute contains the complete feature table row as
a dictionary, which can be used to access all columns including any
additional metadata or columns beyond the primary value.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.FeatureValueRecord.target_rid">target_rid</span></code></td>
            <td>
                  <code><span title="deriva_ml.core.definitions.RID">RID</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RID of the asset/entity this feature value applies to.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.FeatureValueRecord.feature_name">feature_name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the feature.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.FeatureValueRecord.value">value</span></code></td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The feature value (typically a vocabulary term name).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.FeatureValueRecord.execution_rid">execution_rid</span></code></td>
            <td>
                  <code><span title="deriva_ml.core.definitions.RID">RID</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>RID of the execution that created this feature value, if any.
Use this to distinguish between values from different executions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="deriva_ml.dataset.dataset_bag.FeatureValueRecord.raw_record">raw_record</span></code></td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The complete raw record from the feature table as a dictionary.
Access all columns via dict keys, e.g., record.raw_record["MyColumn"].</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Using a value_selector to choose the most recent feature value::</p>
<pre><code>def select_by_execution(records: list[FeatureValueRecord]) -&gt; FeatureValueRecord:
    # Select value from most recent execution (assuming RIDs are sortable)
    return max(records, key=lambda r: r.execution_rid or "")

bag.restructure_assets(
    output_dir="./ml_data",
    group_by=["Diagnosis"],
    value_selector=select_by_execution,
)
</code></pre>
<p>Accessing raw record data::</p>
<pre><code>def select_by_confidence(records: list[FeatureValueRecord]) -&gt; FeatureValueRecord:
    # Select value with highest confidence score from raw record
    return max(records, key=lambda r: r.raw_record.get("Confidence", 0))
</code></pre>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/deriva_ml/dataset/dataset_bag.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FeatureValueRecord</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A feature value record with execution provenance.</span>

<span class="sd">    This class represents a single feature value assigned to an asset,</span>
<span class="sd">    including the execution that created it. Used by restructure_assets</span>
<span class="sd">    when a value_selector function needs to choose between multiple</span>
<span class="sd">    feature values for the same asset.</span>

<span class="sd">    The raw_record attribute contains the complete feature table row as</span>
<span class="sd">    a dictionary, which can be used to access all columns including any</span>
<span class="sd">    additional metadata or columns beyond the primary value.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        target_rid: RID of the asset/entity this feature value applies to.</span>
<span class="sd">        feature_name: Name of the feature.</span>
<span class="sd">        value: The feature value (typically a vocabulary term name).</span>
<span class="sd">        execution_rid: RID of the execution that created this feature value, if any.</span>
<span class="sd">            Use this to distinguish between values from different executions.</span>
<span class="sd">        raw_record: The complete raw record from the feature table as a dictionary.</span>
<span class="sd">            Access all columns via dict keys, e.g., record.raw_record[&quot;MyColumn&quot;].</span>

<span class="sd">    Example:</span>
<span class="sd">        Using a value_selector to choose the most recent feature value::</span>

<span class="sd">            def select_by_execution(records: list[FeatureValueRecord]) -&gt; FeatureValueRecord:</span>
<span class="sd">                # Select value from most recent execution (assuming RIDs are sortable)</span>
<span class="sd">                return max(records, key=lambda r: r.execution_rid or &quot;&quot;)</span>

<span class="sd">            bag.restructure_assets(</span>
<span class="sd">                output_dir=&quot;./ml_data&quot;,</span>
<span class="sd">                group_by=[&quot;Diagnosis&quot;],</span>
<span class="sd">                value_selector=select_by_execution,</span>
<span class="sd">            )</span>

<span class="sd">        Accessing raw record data::</span>

<span class="sd">            def select_by_confidence(records: list[FeatureValueRecord]) -&gt; FeatureValueRecord:</span>
<span class="sd">                # Select value with highest confidence score from raw record</span>
<span class="sd">                return max(records, key=lambda r: r.raw_record.get(&quot;Confidence&quot;, 0))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_rid</span><span class="p">:</span> <span class="n">RID</span>
    <span class="n">feature_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span>
    <span class="n">execution_rid</span><span class="p">:</span> <span class="n">RID</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">raw_record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FeatureValueRecord(target_rid=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_rid</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;feature_name=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_name</span><span class="si">}</span><span class="s2">&#39;, value=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;execution_rid=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_rid</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../dataset/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Dataset">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Dataset
              </div>
            </div>
          </a>
        
        
          
          <a href="../dataset_split/" class="md-footer__link md-footer__link--next" aria-label="Next: Dataset Splitting">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Dataset Splitting
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.expand", "navigation.footer"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>